@page "/budgets/create"
@rendermode InteractiveServer
@layout UserLayout
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using System.ComponentModel.DataAnnotations
@using Project_PiggyPro.Components.Layout
@using Project_PiggyPro.Domain
@using Project_PiggyPro.Data

@inject IDbContextFactory<Project_PiggyPro.Data.Project_PiggyProContext> DbFactory
@inject UserManager<Project_PiggyProUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

<PageTitle>Add Budget Category - PiggyPro</PageTitle>

<div class="create-container">
    <div class="page-header">
        <h1>Add Budget Category</h1>
        <p class="subtitle">Set a budget for a specific category</p>
    </div>

    <div class="form-card">
        <EditForm Model="@budgetModel" OnValidSubmit="CreateBudget" FormName="createBudget">
            <DataAnnotationsValidator />

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">
                    @errorMessage
                </div>
            }

            <!-- Bucket Type Selection -->
            <div class="form-group">
                <label for="bucketType" class="form-label">Budget Type</label>
                <select id="bucketType" @bind="budgetModel.BucketType" class="form-control">
                    <option value="">-- Select Type --</option>
                    <option value="Needs">🏠 Needs (50%)</option>
                    <option value="Wants">🎯 Wants (30%)</option>
                    <option value="Savings">💰 Savings (20%)</option>
                </select>
                <ValidationMessage For="@(() => budgetModel.BucketType)" class="text-danger" />
                <small class="form-text">Choose which category this budget belongs to</small>
            </div>

            <!-- Category Selection -->
            <div class="form-group">
                <label for="categoryId" class="form-label">Category</label>
                <select id="categoryId" @bind="budgetModel.CategoryId" class="form-control">
                    <option value="0">-- Select Category --</option>
                    @foreach (var category in categories)
                    {
                        <option value="@category.Id">@category.CategoryName (@category.CategoryType)</option>
                    }
                </select>
                <ValidationMessage For="@(() => budgetModel.CategoryId)" class="text-danger" />
                <small class="form-text">Select the category you want to budget for</small>
            </div>

            <!-- Budget Amount -->
            <div class="form-group">
                <label for="amount" class="form-label">Monthly Budget Amount</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <InputNumber id="amount" @bind-Value="budgetModel.AllocatedAmount" class="form-control" placeholder="0.00" />
                </div>
                <ValidationMessage For="@(() => budgetModel.AllocatedAmount)" class="text-danger" />
                <small class="form-text">How much do you want to budget per month?</small>
            </div>

            @if (!string.IsNullOrEmpty(budgetModel.BucketType))
            {
                <div class="info-box">
                    <strong>💡 Budget Recommendation:</strong>
                    <p>
                        @if (budgetModel.BucketType == "Needs")
                        {
                            <span>Needs should be around <strong>50%</strong> of your income (essentials like housing, groceries, utilities)</span>
                        }
                        else if (budgetModel.BucketType == "Wants")
                        {
                            <span>Wants should be around <strong>30%</strong> of your income (entertainment, hobbies, dining out)</span>
                        }
                        else if (budgetModel.BucketType == "Savings")
                        {
                            <span>Savings should be around <strong>20%</strong> of your income (emergency fund, investments, retirement)</span>
                        }
                    </p>
                    @if (monthlyIncome > 0)
                    {
                        <p class="recommended-amount">
                            Based on your income of <strong>@monthlyIncome.ToString("C2")</strong>,
                            @if (budgetModel.BucketType == "Needs")
                            {
                                <span>you should allocate about <strong>@((monthlyIncome * 0.50m).ToString("C2"))</strong></span>
                            }
                            else if (budgetModel.BucketType == "Wants")
                            {
                                <span>you should allocate about <strong>@((monthlyIncome * 0.30m).ToString("C2"))</strong></span>
                            }
                            else if (budgetModel.BucketType == "Savings")
                            {
                                <span>you should allocate about <strong>@((monthlyIncome * 0.20m).ToString("C2"))</strong></span>
                            }
                        </p>
                    }
                </div>
            }

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span>Creating...</span>
                    }
                    else
                    {
                        <span>✓ Create Budget</span>
                    }
                </button>
                <a href="/budgets" class="btn btn-secondary">Cancel</a>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? BucketType { get; set; }

    [SupplyParameterFromForm]
    private BudgetCreateModel budgetModel { get; set; } = new();

    private List<Category> categories = new();
    private string currentUserId = string.Empty;
    private decimal monthlyIncome = 0m;
    private string errorMessage = string.Empty;
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated == true)
        {
            var appUser = await UserManager.GetUserAsync(user);
            if (appUser != null)
            {
                currentUserId = appUser.Id;

                // Pre-fill bucket type from query string
                if (!string.IsNullOrEmpty(BucketType))
                {
                    budgetModel.BucketType = BucketType;
                }

                // Load categories (Expense and Savings only)
                categories = await context.Category
                    .Where(c => c.CategoryType == "Expense" || c.CategoryType == "Savings")
                    .OrderBy(c => c.CategoryName)
                    .ToListAsync();

                // Get monthly income for recommendation
                var now = DateTime.Now;
                var startOfMonth = new DateTime(now.Year, now.Month, 1);
                var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);

                monthlyIncome = await context.Transaction
                    .Where(t => t.AppUserId == currentUserId
                        && t.TransactionDate >= startOfMonth
                        && t.TransactionDate <= endOfMonth
                        && t.TransactionType == "Income")
                    .SumAsync(t => (decimal?)t.Amount) ?? 0m;
            }
        }
    }

    private async Task CreateBudget()
    {
        errorMessage = string.Empty;
        isSubmitting = true;

        try
        {
            // Validation
            if (string.IsNullOrEmpty(budgetModel.BucketType))
            {
                errorMessage = "Please select a budget type.";
                return;
            }

            if (budgetModel.CategoryId == 0)
            {
                errorMessage = "Please select a category.";
                return;
            }

            if (budgetModel.AllocatedAmount <= 0)
            {
                errorMessage = "Please enter a valid budget amount.";
                return;
            }

            using var context = DbFactory.CreateDbContext();

            // Check if budget already exists for this category
            var existingBudget = await context.Budget
                .FirstOrDefaultAsync(b => b.AppUserId == currentUserId
                    && b.CategoryId == budgetModel.CategoryId);

            if (existingBudget != null)
            {
                errorMessage = "A budget already exists for this category. Please edit the existing budget instead.";
                return;
            }

            var now = DateTime.Now;
            var startOfMonth = new DateTime(now.Year, now.Month, 1);
            var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);

            var budget = new Budget
            {
                BudgetAmount = monthlyIncome,
                AllocatedAmount = budgetModel.AllocatedAmount,
                BucketType = budgetModel.BucketType,
                StartDate = startOfMonth,
                EndDate = endOfMonth,
                BudgetPeriod = "Monthly",
                RuleName = "50/30/20",
                NeedsPercentage = 50,
                WantsPercentage = 30,
                SavingsPercentage = 20,
                AppUserId = currentUserId,
                CategoryId = budgetModel.CategoryId,
                DateCreated = DateTime.Now,
                CreatedBy = currentUserId,
                DateUpdated = DateTime.Now,
                UpdatedBy = currentUserId
            };

            context.Budget.Add(budget);
            await context.SaveChangesAsync();

            NavigationManager.NavigateTo("/budgets");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating budget: {ex.Message}";
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class BudgetCreateModel
    {
        [Required(ErrorMessage = "Budget type is required")]
        public string BucketType { get; set; } = string.Empty;

        [Required(ErrorMessage = "Category is required")]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a category")]
        public int CategoryId { get; set; }

        [Required(ErrorMessage = "Budget amount is required")]
        [Range(0.01, double.MaxValue, ErrorMessage = "Budget amount must be greater than 0")]
        public decimal AllocatedAmount { get; set; }
    }
}
