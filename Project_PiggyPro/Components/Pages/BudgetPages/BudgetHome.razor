@page "/budgets"
@layout UserLayout
@attribute [Authorize]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Project_PiggyPro.Components.Layout
@using Project_PiggyPro.Domain
@using Project_PiggyPro.Data

@implements IAsyncDisposable

@inject IDbContextFactory<Project_PiggyPro.Data.Project_PiggyProContext> DbFactory
@inject UserManager<Project_PiggyProUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Budget - PiggyPro</PageTitle>

<div class="container budget-container">
    <div class="page-header">
        <div>
            <h1>Budget Management</h1>
            <p class="subtitle">Plan your finances with the 50/30/20 rule</p>
        </div>
    </div>

    <div class="budget-setup-card">
        <h2>Set Your Monthly Income</h2>
        <p class="text-muted">Enter your total monthly income to calculate your budget allocation</p>

        <div class="income-input-section">
            <div class="form-group">
                <label for="monthlyIncome" class="form-label">Monthly Income ($)</label>
                <input type="number" id="monthlyIncome" class="form-control"
                       @bind="monthlyIncome"
                       placeholder="Enter your monthly income" min="0" step="0.01" />
            </div>
            <button type="button" class="btn-primary" @onclick="HandleCalculateClick">Calculate Budget</button>
        </div>

        @if (!string.IsNullOrWhiteSpace(statusMessage))
        {
            <div class="status-message">@statusMessage</div>
        }
    </div>

    <div class="category-assignment-section">
        <h2>Set Your Category Budgets</h2>
        <p class="text-muted">Select categories, set budgets, and track your spending with individual progress bars</p>

        <div class="assignment-grid">
            @* NEEDS COLUMN *@
            <div class="assignment-column needs">
                <div class="column-header">
                    <div class="column-title">
                        <span class="icon">🏠</span>
                        <div class="title-text">
                            <div class="main-title">Needs (50%)</div>
                            <div class="allocated-label">Allocated</div>
                        </div>
                    </div>
                    <div class="allocated-amount">@needsAllocated.ToString("C2")</div>
                </div>

                <div class="categories-list">
                    @foreach (var budget in needsBudgets)
                    {
                        var budgetId = budget.Id;
                        var categoryName = budget.Category?.CategoryName ?? "Unknown";
                        var categoryType = budget.Category?.CategoryType ?? "Unknown";
                        var budgetAmount = budget.AllocatedAmount;

                        <div class="category-card">
                            <div class="category-header">
                                <div class="category-info">
                                    <span class="category-name">@categoryName</span>
                                    <span class="category-type-badge expense">@categoryType</span>
                                </div>
                                <button class="btn-delete" @onclick="@(() => HandleDeleteClick(budgetId))">✕</button>
                            </div>
                            <div class="budget-input-row">
                                <label>Budget:</label>
                                <input type="number" class="budget-input" value="@budgetAmount"
                                       @onchange="@(e => HandleBudgetChange(budgetId, e.Value))"
                                       min="0" step="1" />
                            </div>
                            <div class="allocated-info">allocated per month</div>
                            @{
                                var spent = GetSpentAmount(budget.CategoryId);
                                var remaining = budgetAmount - spent;
                                var percentage = budgetAmount > 0 ? (double)(spent / budgetAmount) * 100 : 0;
                                var progressClass = percentage > 100 ? "over" : percentage > 75 ? "warning" : "good";
                            }
                            <div class="progress-bar">
                                <div class="progress-fill @progressClass" style="width: @Math.Min(percentage, 100)%"></div>
                            </div>
                            <div class="budget-summary">
                                <span class="@(percentage > 100 ? "over-budget" : "")">@spent.ToString("C2") spent</span>
                                <span class="@(remaining < 0 ? "over-budget" : "")">@remaining.ToString("C2") @(remaining < 0 ? "over" : "left")</span>
                            </div>
                        </div>
                    }
                </div>
                <button class="btn-add-category" @onclick='@(() => HandleAddCategoryClick("Needs"))'>
                    ➕ Add Category
                </button>
            </div>

            @* WANTS COLUMN *@
            <div class="assignment-column wants">
                <div class="column-header">
                    <div class="column-title">
                        <span class="icon">🎯</span>
                        <div class="title-text">
                            <div class="main-title">Wants (30%)</div>
                            <div class="allocated-label">Allocated</div>
                        </div>
                    </div>
                    <div class="allocated-amount">@wantsAllocated.ToString("C2")</div>
                </div>

                <div class="categories-list">
                    @foreach (var budget in wantsBudgets)
                    {
                        var budgetId = budget.Id;
                        var categoryName = budget.Category?.CategoryName ?? "Unknown";
                        var categoryType = budget.Category?.CategoryType ?? "Unknown";
                        var budgetAmount = budget.AllocatedAmount;

                        <div class="category-card">
                            <div class="category-header">
                                <div class="category-info">
                                    <span class="category-name">@categoryName</span>
                                    <span class="category-type-badge expense">@categoryType</span>
                                </div>
                                <button class="btn-delete" @onclick="@(() => HandleDeleteClick(budgetId))">✕</button>
                            </div>
                            <div class="budget-input-row">
                                <label>Budget:</label>
                                <input type="number" class="budget-input" value="@budgetAmount"
                                       @onchange="@(e => HandleBudgetChange(budgetId, e.Value))"
                                       min="0" step="1" />
                            </div>
                            <div class="allocated-info">allocated per month</div>
                            @{
                                var spent = GetSpentAmount(budget.CategoryId);
                                var remaining = budgetAmount - spent;
                                var percentage = budgetAmount > 0 ? (double)(spent / budgetAmount) * 100 : 0;
                                var progressClass = percentage > 100 ? "over" : percentage > 75 ? "warning" : "good";
                            }
                            <div class="progress-bar">
                                <div class="progress-fill @progressClass" style="width: @Math.Min(percentage, 100)%"></div>
                            </div>
                            <div class="budget-summary">
                                <span class="@(percentage > 100 ? "over-budget" : "")">@spent.ToString("C2") spent</span>
                                <span class="@(remaining < 0 ? "over-budget" : "")">@remaining.ToString("C2") @(remaining < 0 ? "over" : "left")</span>
                            </div>
                        </div>
                    }
                </div>
                <button class="btn-add-category" @onclick='@(() => HandleAddCategoryClick("Wants"))'>
                    ➕ Add Category
                </button>
            </div>

            @* SAVINGS COLUMN *@
            <div class="assignment-column savings">
                <div class="column-header">
                    <div class="column-title">
                        <span class="icon">💰</span>
                        <div class="title-text">
                            <div class="main-title">Savings (20%)</div>
                            <div class="allocated-label">Allocated</div>
                        </div>
                    </div>
                    <div class="allocated-amount">@savingsAllocated.ToString("C2")</div>
                </div>

                <div class="categories-list">
                    @foreach (var budget in savingsBudgets)
                    {
                        var budgetId = budget.Id;
                        var categoryName = budget.Category?.CategoryName ?? "Unknown";
                        var categoryType = budget.Category?.CategoryType ?? "Unknown";
                        var budgetAmount = budget.AllocatedAmount;

                        <div class="category-card">
                            <div class="category-header">
                                <div class="category-info">
                                    <span class="category-name">@categoryName</span>
                                    <span class="category-type-badge savings">@categoryType</span>
                                </div>
                                <button class="btn-delete" @onclick="@(() => HandleDeleteClick(budgetId))">✕</button>
                            </div>
                            <div class="budget-input-row">
                                <label>Budget:</label>
                                <input type="number" class="budget-input" value="@budgetAmount"
                                       @onchange="@(e => HandleBudgetChange(budgetId, e.Value))"
                                       min="0" step="1" />
                            </div>
                            <div class="allocated-info">allocated per month</div>
                            @{
                                var spent = GetSpentAmount(budget.CategoryId);
                                var remaining = budgetAmount - spent;
                                var percentage = budgetAmount > 0 ? (double)(spent / budgetAmount) * 100 : 0;
                                var progressClass = percentage > 100 ? "over" : percentage > 75 ? "warning" : "good";
                            }
                            <div class="progress-bar">
                                <div class="progress-fill @progressClass" style="width: @Math.Min(percentage, 100)%"></div>
                            </div>
                            <div class="budget-summary">
                                <span class="@(percentage > 100 ? "over-budget" : "")">@spent.ToString("C2") spent</span>
                                <span class="@(remaining < 0 ? "over-budget" : "")">@remaining.ToString("C2") @(remaining < 0 ? "over" : "left")</span>
                            </div>
                        </div>
                    }
                </div>
                <button class="btn-add-category" @onclick='@(() => HandleAddCategoryClick("Savings"))'>
                    ➕ Add Category
                </button>
            </div>
        </div>

        <div class="budget-totals">
            <div class="total-row">
                <span>Total Budgeted:</span>
                <span class="total-amount">@totalBudgeted.ToString("C2")</span>
            </div>
            <div class="total-row remaining">
                <span>Remaining:</span>
                <span class="total-amount remaining-amount">@budgetRemaining.ToString("C2")</span>
            </div>
        </div>
    </div>
</div>

@* ADD CATEGORY MODAL *@
@if (showModal)
{
    <div class="modal-overlay" @onclick="HandleModalOverlayClick">
        <div class="modal-content" @onclick:stopPropagation="true">
            <button class="modal-close" @onclick="HandleCloseModal">✕</button>
            <h3 class="modal-title">➕ Add Category</h3>

            <div class="modal-body">
                <div class="form-group">
                    <label>Select Category:</label>
                    <select class="form-select" @bind="selectedCategoryId">
                        <option value="0">-- Choose a category --</option>
                        @foreach (var category in availableCategories)
                        {
                            <option value="@category.Id">@category.CategoryName (@category.CategoryType)</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label>Set Budget:</label>
                    <input type="number" class="form-control" @bind="newBudgetAmount"
                           placeholder="Budget Amount" min="0" step="1" />
                </div>

                <div class="modal-actions">
                    <button class="btn btn-primary" @onclick="HandleAddCategory">Add</button>
                    <button class="btn btn-secondary" @onclick="HandleCloseModal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private Project_PiggyProContext context = default!;
    private string currentUserId = string.Empty;

    private decimal monthlyIncome = 0m;
    private decimal needsAllocated = 0m;
    private decimal wantsAllocated = 0m;
    private decimal savingsAllocated = 0m;

    private List<Budget> needsBudgets = new();
    private List<Budget> wantsBudgets = new();
    private List<Budget> savingsBudgets = new();

    private List<Category> availableCategories = new();

    private bool showModal = false;
    private string currentBucketType = "";
    private int selectedCategoryId = 0;
    private decimal newBudgetAmount = 0m;

    private string statusMessage = "";

    private decimal totalBudgeted = 0m;
    private decimal budgetRemaining = 0m;

    private List<Transaction> transactions = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            context = DbFactory.CreateDbContext();

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user?.Identity?.IsAuthenticated == true)
            {
                var appUser = await UserManager.GetUserAsync(user);
                if (appUser != null)
                {
                    currentUserId = appUser.Id;
                    await LoadData();
                }
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Initialization Error: {ex.Message}";
            Console.WriteLine($"Init Error: {ex}");
        }
    }

    private async Task LoadData()
    {
        try
        {
            var now = DateTime.Now;

            var budgets = await context.Budget
                .Include(b => b.Category)
                .Where(b => b.AppUserId == currentUserId
                    && b.StartDate <= now
                    && b.EndDate >= now)
                .ToListAsync();

            needsBudgets = budgets.Where(b => b.BucketType == "Needs").ToList();
            wantsBudgets = budgets.Where(b => b.BucketType == "Wants").ToList();
            savingsBudgets = budgets.Where(b => b.BucketType == "Savings").ToList();

            needsAllocated = needsBudgets.Sum(b => b.AllocatedAmount);
            wantsAllocated = wantsBudgets.Sum(b => b.AllocatedAmount);
            savingsAllocated = savingsBudgets.Sum(b => b.AllocatedAmount);

            if (budgets.Any())
            {
                monthlyIncome = (decimal)budgets.First().BudgetAmount;
            }

            var startOfMonth = new DateTime(now.Year, now.Month, 1);
            var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);

            transactions = await context.Transaction
                .Where(t => t.AppUserId == currentUserId
                    && t.TransactionDate >= startOfMonth
                    && t.TransactionDate <= endOfMonth)
                .ToListAsync();

            availableCategories = await context.Category
                .Where(c => c.CategoryType == "Expense" || c.CategoryType == "Savings")
                .OrderBy(c => c.CategoryName)
                .ToListAsync();

            CalculateTotals();
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Load Error: {ex.Message}";
            Console.WriteLine($"Load Error: {ex}");
        }
    }

    private void HandleCalculateClick()
    {
        try
        {
            Console.WriteLine($"Calculate clicked! Income: {monthlyIncome}");

            if (monthlyIncome <= 0)
            {
                statusMessage = "⚠️ Please enter a valid monthly income.";
                return;
            }

            needsAllocated = Math.Round(monthlyIncome * 0.50m, 2);
            wantsAllocated = Math.Round(monthlyIncome * 0.30m, 2);
            savingsAllocated = Math.Round(monthlyIncome * 0.20m, 2);

            statusMessage = $"✅ Budget calculated! Needs: {needsAllocated:C2}, Wants: {wantsAllocated:C2}, Savings: {savingsAllocated:C2}";
            CalculateTotals();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Calculate Error: {ex.Message}";
            Console.WriteLine($"Calculate Error: {ex}");
        }
    }

    private void HandleAddCategoryClick(string bucketType)
    {
        try
        {
            Console.WriteLine($"Add Category clicked for: {bucketType}");
            currentBucketType = bucketType;
            selectedCategoryId = 0;
            newBudgetAmount = 0m;
            showModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Error: {ex.Message}";
            Console.WriteLine($"Add Category Error: {ex}");
        }
    }

    private void HandleModalOverlayClick()
    {
        showModal = false;
        StateHasChanged();
    }

    private void HandleCloseModal()
    {
        showModal = false;
        StateHasChanged();
    }

    private async Task HandleAddCategory()
    {
        try
        {
            if (selectedCategoryId == 0)
            {
                statusMessage = "⚠️ Please select a category.";
                return;
            }

            if (newBudgetAmount <= 0)
            {
                statusMessage = "⚠️ Please enter a valid budget amount.";
                return;
            }

            var now = DateTime.Now;
            var startOfMonth = new DateTime(now.Year, now.Month, 1);
            var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);

            var budget = new Budget
            {
                BudgetAmount = (double)monthlyIncome,
                AllocatedAmount = newBudgetAmount,
                BucketType = currentBucketType,
                StartDate = startOfMonth,
                EndDate = endOfMonth,
                BudgetPeriod = "Monthly",
                RuleName = "50/30/20",
                NeedsPercentage = 50,
                WantsPercentage = 30,
                SavingsPercentage = 20,
                AppUserId = currentUserId,
                CategoryId = selectedCategoryId,
                DateCreated = DateTime.Now,
                CreatedBy = currentUserId,
                DateUpdated = DateTime.Now,
                UpdatedBy = currentUserId
            };

            context.Budget.Add(budget);
            await context.SaveChangesAsync();

            await LoadData();
            showModal = false;
            statusMessage = "✅ Category added successfully!";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Error adding category: {ex.Message}";
            Console.WriteLine($"Add Category Error: {ex}");
        }
    }

    private async Task HandleBudgetChange(int budgetId, object? value)
    {
        try
        {
            if (value == null) return;

            var newAmount = decimal.Parse(value.ToString() ?? "0");
            var budget = await context.Budget.FindAsync(budgetId);

            if (budget != null)
            {
                budget.AllocatedAmount = newAmount;
                budget.DateUpdated = DateTime.Now;
                budget.UpdatedBy = currentUserId;
                context.Budget.Update(budget);
                await context.SaveChangesAsync();

                await LoadData();
                statusMessage = "✅ Budget updated!";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Update Error: {ex.Message}";
            Console.WriteLine($"Budget Change Error: {ex}");
        }
    }

    private async Task HandleDeleteClick(int budgetId)
    {
        try
        {
            var budget = await context.Budget.FindAsync(budgetId);
            if (budget != null)
            {
                context.Budget.Remove(budget);
                await context.SaveChangesAsync();
                await LoadData();
                statusMessage = "✅ Category removed!";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Delete Error: {ex.Message}";
            Console.WriteLine($"Delete Error: {ex}");
        }
    }

    private decimal GetSpentAmount(int categoryId)
    {
        try
        {
            return transactions
                .Where(t => t.CategoryId == categoryId && t.TransactionType == "Expense")
                .Sum(t => t.Amount);
        }
        catch
        {
            return 0m;
        }
    }

    private void CalculateTotals()
    {
        totalBudgeted = needsBudgets.Sum(b => b.AllocatedAmount) +
                       wantsBudgets.Sum(b => b.AllocatedAmount) +
                       savingsBudgets.Sum(b => b.AllocatedAmount);
        budgetRemaining = monthlyIncome - totalBudgeted;
    }

    public async ValueTask DisposeAsync()
    {
        if (context != null)
            await context.DisposeAsync();
    }
}
