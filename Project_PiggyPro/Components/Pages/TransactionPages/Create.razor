@page "/transactions/create"
@rendermode InteractiveServer
@layout UserLayout
@attribute [Authorize]
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using Project_PiggyPro.Components.Layout
@using Project_PiggyPro.Data
@using Project_PiggyPro.Domain
@using Project_PiggyPro.Configurations.Entities
@using Project_PiggyPro.Services
@inject IInAppNotificationService NotificationService
@inject IDbContextFactory<Project_PiggyPro.Data.Project_PiggyProContext> DbFactory
@inject UserManager<Project_PiggyProUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

<PageTitle>Add Transaction - PiggyPro</PageTitle>

<div class="transaction-create-container">
    <div class="page-header">
        <h1>Add New Transaction</h1>
        <p class="subtitle">Record your income or expense</p>
    </div>

    <div class="transaction-form-card">
        <EditForm Model="Transaction" OnValidSubmit="AddTransaction">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />

            <!-- Transaction Type Toggle -->
            <div class="form-group">
                <label class="form-label-custom">Transaction Type</label>
                <div class="type-toggle">
                    <button type="button"
                            class="type-btn @(selectedType == "Income" ? "active income" : "")"
                            @onclick="@(() => SelectType("Income"))">
                        Income
                    </button>
                    <button type="button"
                            class="type-btn @(selectedType == "Expense" ? "active expense" : "")"
                            @onclick="@(() => SelectType("Expense"))">
                        Expense
                    </button>
                </div>
            </div>

            <!-- Amount -->
            <div class="form-group">
                <label for="amount" class="form-label-custom">Amount ($)</label>
                <InputNumber id="amount" @bind-Value="Transaction.Amount" class="form-control-custom" placeholder="0.00" />
                <ValidationMessage For="() => Transaction.Amount" class="text-danger" />
            </div>

            <!-- Category Dropdown -->
            <div class="form-group">
                <label for="category" class="form-label-custom">Category</label>
                <InputSelect id="category" @bind-Value="SelectedCategoryId" class="form-control-custom">
                    <option value="0">Select a category...</option>
                    @foreach (var category in filteredCategories)
                    {
                        <option value="@category.Id">@category.CategoryName</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => Transaction.CategoryId" class="text-danger" />
            </div>

            <!-- Budget Allocation Warning for Expenses -->
            @if ((selectedType == "Expense" || selectedType =="Savings") && Transaction.CategoryId > 0 && !isCategoryAllocated)
            {
                <div class="budget-warning-card">
                    <div class="warning-icon">⚠️</div>
                    <div class="warning-content">
                        <h4>Budget Not Allocated</h4>
                        <p>
                            The selected category <strong>"@GetSelectedCategoryName()"</strong> has not been allocated in your budget for @DateTime.Now.ToString("MMMM yyyy").
                        </p>
                        <p>
                            To track your expenses properly and stay within budget, please allocate this category first.
                        </p>
                        <div class="warning-actions">
                            <a href="/budgets" class="btn-allocate">
                                📊 Go to Budget Management
                            </a>
                            <span class="or-text">or</span>
                            <button type="button" @onclick="ProceedWithoutBudget" class="btn-proceed-anyway">
                                Proceed Anyway
                            </button>
                        </div>
                    </div>
                </div>
            }

            <!-- Date -->
            <div class="form-group">
                <label for="date" class="form-label-custom">Date</label>
                <InputDate id="date" @bind-Value="Transaction.TransactionDate" class="form-control-custom" />
                <ValidationMessage For="() => Transaction.TransactionDate" class="text-danger" />
            </div>

            <!-- Description -->
            <div class="form-group">
                <label for="description" class="form-label-custom">Description (Optional)</label>
                <InputTextArea id="description" @bind-Value="Transaction.Description" class="form-control-custom textarea" rows="3" placeholder="Add notes about this transaction..." />
                <ValidationMessage For="() => Transaction.Description" class="text-danger" />
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="button" class="btn-cancel" @onclick="Cancel">Cancel</button>
                <button type="submit" class="btn-save">Save Transaction</button>
            </div>
        </EditForm>
    </div>

    <!-- Quick Tips -->
    <div class="quick-tips">
        <h4>💡 Quick Tips</h4>
        <ul>
            <li>Set up budgets for your expense categories to track spending</li>
            <li>Add descriptions to remember what each transaction was for</li>
            <li>Review your transactions regularly to stay on track</li>
            <li>Income transactions increase your available budget</li>
        </ul>
    </div>
</div>

@code {
    private Project_PiggyPro.Domain.Transaction Transaction { get; set; } = new()
    {
        TransactionDate = DateTime.Today
    };

    private string currentUserId = string.Empty;
    private string selectedType = "Expense";
    private List<Category> allCategories = new();
    private List<Category> filteredCategories = new();
    private bool isCategoryAllocated = true;
    private bool userConfirmedProceed = false;

    private int SelectedCategoryId
    {
        get => Transaction.CategoryId;
        set
        {
            Transaction.CategoryId = value;
            userConfirmedProceed = false;
            _ = CheckCategoryAllocation();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await UserManager.GetUserAsync(user);
            if (appUser != null)
            {
                currentUserId = appUser.Id;
            }
        }

        using var context = DbFactory.CreateDbContext();
        allCategories = await context.Category.ToListAsync();
        FilterCategories();
    }

    private void SelectType(string type)
    {
        selectedType = type;
        Transaction.CategoryId = 0;
        FilterCategories();
        isCategoryAllocated = true;
        userConfirmedProceed = false;
    }

    private void FilterCategories()
    {
        if (selectedType == "Expense")
        {
            filteredCategories = allCategories
                .Where(c => c.CategoryType == "Expense" || c.CategoryType == "Savings")
                .ToList();
        }
        else
        {
            filteredCategories = allCategories
                .Where(c => c.CategoryType == selectedType)
                .ToList();
        }
    }

    private async Task CheckCategoryAllocation()
    {
        using var context = DbFactory.CreateDbContext();

        // Get current month period
        var currentMonthStart = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
        var currentMonthEnd = currentMonthStart.AddMonths(1).AddDays(-1);

        // Check if this category has an allocated budget for current month
        var hasBudget = await context.Budget
            .AnyAsync(b => b.AppUserId == currentUserId
                && b.CategoryId == Transaction.CategoryId
                && b.StartDate <= currentMonthEnd
                && b.EndDate >= currentMonthStart);

        isCategoryAllocated = hasBudget;
        StateHasChanged(); // Force UI update
    }

    private string GetSelectedCategoryName()
    {
        var category = allCategories.FirstOrDefault(c => c.Id == Transaction.CategoryId);
        return category?.CategoryName ?? "Unknown";
    }

    private void ProceedWithoutBudget()
    {
        userConfirmedProceed = true;
        StateHasChanged();
    }

    private async Task AddTransaction()
    {
        if (Transaction.CategoryId == 0)
        {
            return;
        }

        // Double-check budget allocation for expenses (unless user confirmed to proceed)
        if (selectedType == "Expense" && !isCategoryAllocated && !userConfirmedProceed)
        {
            return;
        }

        using var context = DbFactory.CreateDbContext();

        Transaction.AppUserId = currentUserId;
        Transaction.TransactionType = selectedType;
        Transaction.CreatedBy = currentUserId;
        Transaction.UpdatedBy = currentUserId;
        Transaction.DateCreated = DateTime.Now;
        Transaction.DateUpdated = DateTime.Now;

        context.Transaction.Add(Transaction);
        await context.SaveChangesAsync();

        // 🔔 TRIGGER NOTIFICATIONS FOR BUDGET ALERTS
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = UserManager.GetUserId(authState.User);

            if (!string.IsNullOrEmpty(userId) && Transaction.CategoryId > 0)
            {
                // Get category to check if it's income or expense
                var category = await context.Category.FindAsync(Transaction.CategoryId);

                // Only check budget for expenses (not income)
                if (category?.CategoryType != "Income")
                {
                    // ✅ FIXED: Check budget for CURRENT MONTH with date range
                    var startOfMonth = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
                    var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);

                    var budget = await context.Budget
                        .FirstOrDefaultAsync(b =>
                            b.CategoryId == Transaction.CategoryId &&
                            b.CreatedBy == userId &&
                            b.StartDate <= endOfMonth &&
                            b.EndDate >= startOfMonth);

                    if (budget != null)
                    {
                        // Calculate total spent this month in this category
                        var spent = await context.Transaction
                            .Where(t =>
                                t.CategoryId == Transaction.CategoryId &&
                                t.CreatedBy == userId &&
                                t.DateCreated >= startOfMonth &&
                                t.DateCreated <= endOfMonth)
                            .SumAsync(t => t.Amount);

                        var percentage = (spent / budget.AllocatedAmount) * 100;
                        var categoryName = category?.CategoryName ?? "Unknown";

                        Console.WriteLine($"📊 Budget Check: {categoryName} - Spent: ${spent:N2} / ${budget.AllocatedAmount:N2} ({percentage:N1}%)");

                        // Send alert if 80% or more BUT less than 100%
                        if (percentage >= 80 && percentage < 100)
                        {
                            Console.WriteLine($"⚠️ Sending 80% alert for {categoryName}");
                            await NotificationService.NotifyBudgetAlertAsync(
                                userId,
                                categoryName,
                                spent,
                                budget.AllocatedAmount,
                                percentage
                            );
                        }

                        // Send exceeded alert if over 100%
                        if (percentage >= 100)
                        {
                            Console.WriteLine($"🚨 Sending budget exceeded alert for {categoryName}");
                            await NotificationService.NotifyBudgetExceededAsync(
                                userId,
                                categoryName,
                                spent,
                                budget.AllocatedAmount
                            );
                        }
                    }
                    else
                    {
                        Console.WriteLine($"⚠️ No budget found for category: {category?.CategoryName}");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            // Log error but don't block transaction
            Console.WriteLine($"❌ Error sending notification: {ex.Message}");
        }

        NavigationManager.NavigateTo("/transactions");
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/transactions");
    }
}
