@page "/transactions/create"
@rendermode InteractiveServer
@layout UserLayout
@attribute [Authorize]
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using Project_PiggyPro.Components.Layout
@using Project_PiggyPro.Data
@using Project_PiggyPro.Domain
@using Project_PiggyPro.Configurations.Entities
@inject IDbContextFactory<Project_PiggyPro.Data.Project_PiggyProContext> DbFactory
@inject UserManager<Project_PiggyProUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

<PageTitle>Add Transaction - PiggyPro</PageTitle>

<div class="transaction-create-container">
    <div class="page-header">
        <h1>Add New Transaction</h1>
        <p class="subtitle">Record your income or expense</p>
    </div>

    <div class="transaction-form-card">
        <EditForm Model="Transaction" OnValidSubmit="AddTransaction">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />

            <!-- Transaction Type Toggle -->
            <div class="form-group">
                <label class="form-label-custom">Transaction Type</label>
                <div class="type-toggle">
                    <button type="button"
                            class="type-btn @(selectedType == "Income" ? "active income" : "")"
                            @onclick="@(() => SelectType("Income"))">
                        Income
                    </button>
                    <button type="button"
                            class="type-btn @(selectedType == "Expense" ? "active expense" : "")"
                            @onclick="@(() => SelectType("Expense"))">
                        Expense
                    </button>
                </div>
            </div>

            <!-- Amount -->
            <div class="form-group">
                <label for="amount" class="form-label-custom">Amount ($)</label>
                <InputNumber id="amount" @bind-Value="Transaction.Amount" class="form-control-custom" placeholder="0.00" />
                <ValidationMessage For="() => Transaction.Amount" class="text-danger" />
            </div>

            <!-- Category Dropdown -->
            <div class="form-group">
                <label for="category" class="form-label-custom">Category</label>
                <InputSelect id="category" @bind-Value="SelectedCategoryId" class="form-control-custom">
                    <option value="0">Select a category...</option>
                    @foreach (var category in filteredCategories)
                    {
                        <option value="@category.Id">@category.CategoryName</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => Transaction.CategoryId" class="text-danger" />
            </div>

            <!-- Budget Allocation Warning for Expenses -->
            @if (selectedType == "Expense" && Transaction.CategoryId > 0 && !isCategoryAllocated)
            {
                <div class="budget-warning-card">
                    <div class="warning-icon">⚠️</div>
                    <div class="warning-content">
                        <h4>Budget Not Allocated</h4>
                        <p>
                            The selected category <strong>"@GetSelectedCategoryName()"</strong> has not been allocated in your budget for @DateTime.Now.ToString("MMMM yyyy").
                        </p>
                        <p>
                            To track your expenses properly and stay within budget, please allocate this category first.
                        </p>
                        <div class="warning-actions">
                            <a href="/budgets" class="btn-allocate">
                                📊 Go to Budget Management
                            </a>
                            <span class="or-text">or</span>
                            <button type="button" @onclick="ProceedWithoutBudget" class="btn-proceed-anyway">
                                Proceed Anyway
                            </button>
                        </div>
                    </div>
                </div>
            }

            <!-- Date -->
            <div class="form-group">
                <label for="date" class="form-label-custom">Date</label>
                <InputDate id="date" @bind-Value="Transaction.TransactionDate" class="form-control-custom" />
                <ValidationMessage For="() => Transaction.TransactionDate" class="text-danger" />
            </div>

            <!-- Description -->
            <div class="form-group">
                <label for="description" class="form-label-custom">Description (Optional)</label>
                <InputTextArea id="description" @bind-Value="Transaction.Description" class="form-control-custom textarea" placeholder="Add notes about this transaction..." rows="4" />
            </div>

            <!-- Buttons -->
            <div class="form-actions">
                <button type="submit"
                        class="btn-save"
                        disabled="@(selectedType == "Expense" && Transaction.CategoryId > 0 && !isCategoryAllocated && !userConfirmedProceed)">
                    Save Transaction
                </button>
                <button type="button" class="btn-cancel" @onclick="Cancel">Cancel</button>
            </div>
        </EditForm>

        <!-- Quick Tips -->
        <div class="quick-tips">
            <h4>Quick Tips</h4>
            <ul>
                <li>Choose the correct transaction type (Income or Expense)</li>
                <li>Select an appropriate category to track spending patterns</li>
                <li>For expenses, ensure the category is allocated in your budget</li>
                <li>Add descriptions for easier future reference</li>
            </ul>
        </div>
    </div>
</div>

@code {
    private Transaction Transaction { get; set; } = new();
    private List<Category> allCategories = new();
    private List<Category> filteredCategories = new();
    private string currentUserId = string.Empty;
    private string selectedType = "Expense";
    private bool isCategoryAllocated = true;
    private bool userConfirmedProceed = false;

    private int selectedCategoryId;
    private int SelectedCategoryId
    {
        get => selectedCategoryId;
        set
        {
            if (selectedCategoryId != value)
            {
                selectedCategoryId = value;
                Transaction.CategoryId = value;
                userConfirmedProceed = false;

                // Check allocation when category changes
                if (selectedType == "Expense" && value > 0)
                {
                    _ = CheckCategoryAllocation();
                }
                else
                {
                    isCategoryAllocated = true;
                }
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = UserManager.GetUserId(user);
        }

        Transaction.TransactionDate = DateTime.Today;
        Transaction.TransactionType = "Expense";
        selectedType = "Expense";

        using var context = DbFactory.CreateDbContext();
        allCategories = await context.Category
            .Where(c => c.IsSystemCategory == true)
            .OrderBy(c => c.CategoryName)
            .ToListAsync();

        FilterCategories();
    }

    private void SelectType(string type)
    {
        selectedType = type;
        Transaction.TransactionType = type;
        Transaction.CategoryId = 0;
        SelectedCategoryId = 0;
        isCategoryAllocated = true;
        userConfirmedProceed = false;
        FilterCategories();
    }

    private void FilterCategories()
    {
        filteredCategories = allCategories
            .Where(c => c.CategoryType == selectedType)
            .ToList();
    }

    private async Task CheckCategoryAllocation()
    {
        using var context = DbFactory.CreateDbContext();

        // Get current month period
        var currentMonthStart = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
        var currentMonthEnd = currentMonthStart.AddMonths(1).AddDays(-1);

        // Check if this category has an allocated budget for current month
        var hasBudget = await context.Budget
            .AnyAsync(b => b.AppUserId == currentUserId
                && b.CategoryId == Transaction.CategoryId
                && b.StartDate <= currentMonthEnd
                && b.EndDate >= currentMonthStart);

        isCategoryAllocated = hasBudget;
        StateHasChanged(); // Force UI update
    }

    private string GetSelectedCategoryName()
    {
        var category = allCategories.FirstOrDefault(c => c.Id == Transaction.CategoryId);
        return category?.CategoryName ?? "Unknown";
    }

    private void ProceedWithoutBudget()
    {
        userConfirmedProceed = true;
        StateHasChanged();
    }

    private async Task AddTransaction()
    {
        if (Transaction.CategoryId == 0)
        {
            return;
        }

        // Double-check budget allocation for expenses (unless user confirmed to proceed)
        if (selectedType == "Expense" && !isCategoryAllocated && !userConfirmedProceed)
        {
            return;
        }

        using var context = DbFactory.CreateDbContext();

        Transaction.AppUserId = currentUserId;
        Transaction.TransactionType = selectedType;
        Transaction.CreatedBy = currentUserId;
        Transaction.UpdatedBy = currentUserId;
        Transaction.DateCreated = DateTime.Now;
        Transaction.DateUpdated = DateTime.Now;

        context.Transaction.Add(Transaction);
        await context.SaveChangesAsync();

        NavigationManager.NavigateTo("/transactions");
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/transactions");
    }
}
