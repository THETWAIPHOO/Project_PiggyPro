@page "/User/UserDashboard"
@rendermode InteractiveServer
@layout UserLayout
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Project_PiggyPro.Configurations.Entities
@using Project_PiggyPro.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity

@inject Project_PiggyProContext DbContext
@inject UserManager<Project_PiggyProUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>Dashboard - PiggyPro</PageTitle>

<!-- Welcome Section -->
<div class="welcome-section">
    <h1 class="welcome-title">Welcome back, @userName! 👋</h1>
    <p class="welcome-subtitle">Here's your financial overview for @currentMonth</p>
</div>

<!-- Summary Cards -->
<div class="summary-grid">
    <div class="summary-card">
        <div class="card-title">Total Income</div>
        <div class="card-value income">$@totalIncome.ToString("N2")</div>
        <div class="card-subtitle">This month</div>
    </div>

    <div class="summary-card">
        <div class="card-title">Total Expenses</div>
        <div class="card-value expense">$@totalExpenses.ToString("N2")</div>
        <div class="card-subtitle">This month</div>
    </div>

    <div class="summary-card">
        <div class="card-title">Net Balance</div>
        <div class="card-value">$@netBalance.ToString("N2")</div>
        <div class="card-change @(percentageChange >= 0 ? "positive" : "negative")">
            @(percentageChange >= 0 ? "+" : "")@percentageChange.ToString("N0")% vs last month
        </div>
    </div>

    <div class="summary-card">
        <div class="card-title">Budget Status</div>
        <div class="card-value">@budgetUsedPercentage%</div>
        <div class="card-subtitle">of budget used</div>
        <div class="progress-bar-container">
            <div class="progress-bar @GetBudgetStatusClass()" style="width: @budgetUsedPercentage%"></div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
    <!-- Spending Trend Chart -->
    <div class="chart-card">
        <h2 class="chart-title">Spending Trend Over Time</h2>
        <p class="chart-subtitle">Last 30 Days</p>
        <div class="chart-container">
            <canvas id="spendingTrendChart"></canvas>
        </div>
    </div>

    <!-- Category Chart -->
    <div class="chart-card">
        <h2 class="chart-title">Top Categories</h2>
        <p class="chart-subtitle">This Month</p>
        <div class="chart-container">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="transactions-section">
    <div class="section-header">
        <h2 class="section-title">Recent Transactions</h2>
        <a href="/transactions" class="btn-link">View All</a>
    </div>

    @if (recentTransactions.Any())
    {
        <table class="transactions-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var transaction in recentTransactions)
                {
                    <tr>
                        <td>@transaction.Date.ToString("MMM dd, yyyy")</td>
                        <td>@transaction.Description</td>
                        <td>@transaction.CategoryName</td>
                        <td class="@(transaction.Type == "Income" ? "amount-income" : "amount-expense")">
                            @(transaction.Type == "Income" ? "+" : "-")$@transaction.Amount.ToString("N2")
                        </td>
                        <td>
                            <span class="badge @(transaction.Type == "Income" ? "badge-income" : "badge-expense")">
                                @transaction.Type
                            </span>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p class="text-muted">
            No transactions yet.
            <a href="/transactions/create">Add your first transaction</a>
        </p>
    }
</div>

@code {
    private string currentUserId = string.Empty;
    private string userName = string.Empty;
    private string currentMonth = DateTime.Now.ToString("MMMM yyyy");

    private decimal totalIncome = 0;
    private decimal totalExpenses = 0;
    private decimal netBalance = 0;
    private int budgetUsedPercentage = 0;
    private decimal percentageChange = 0;

    private List<TransactionViewModel> recentTransactions = new();
    private List<DailySpending> dailySpendingData = new();
    private List<CategoryExpense> categoryExpenseData = new();

    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var claimsUser = authState.User;

        if (claimsUser?.Identity?.IsAuthenticated == true)
        {
            currentUserId = UserManager.GetUserId(claimsUser) ?? string.Empty;

            var user = await UserManager.GetUserAsync(claimsUser);
            if (user != null)
            {
                userName = string.IsNullOrWhiteSpace(user.FirstName)
                    ? (user.Email ?? "User")
                    : $"{user.FirstName} {user.LastName}".Trim();
            }

            await LoadDashboardData();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!isLoading)
        {
            await RenderCharts();
        }
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var startOfMonth = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);

            // Load summary data
            totalIncome = await DbContext.Transaction
                .Where(t => t.CreatedBy == currentUserId
                    && t.DateCreated >= startOfMonth
                    && t.DateCreated <= endOfMonth)
                .Where(t => DbContext.Category.Any(c => c.Id == t.CategoryId && c.CategoryType == "Income"))
                .SumAsync(t => (decimal?)t.Amount) ?? 0;

            totalExpenses = await DbContext.Transaction
                .Where(t => t.CreatedBy == currentUserId
                    && t.DateCreated >= startOfMonth
                    && t.DateCreated <= endOfMonth)
                .Where(t => DbContext.Category.Any(c => c.Id == t.CategoryId && c.CategoryType == "Expense"))
                .SumAsync(t => (decimal?)t.Amount) ?? 0;

            netBalance = totalIncome - totalExpenses;

            var totalBudget = await DbContext.Budget
                .Where(b => b.CreatedBy == currentUserId)
                .SumAsync(b => (decimal?)b.BudgetAmount) ?? 0;

            if (totalBudget > 0)
            {
                budgetUsedPercentage = (int)((totalExpenses / totalBudget) * 100);
            }

            var lastMonthStart = startOfMonth.AddMonths(-1);
            var lastMonthEnd = startOfMonth.AddDays(-1);

            var lastMonthIncome = await DbContext.Transaction
                .Where(t => t.CreatedBy == currentUserId
                    && t.DateCreated >= lastMonthStart
                    && t.DateCreated <= lastMonthEnd)
                .Where(t => DbContext.Category.Any(c => c.Id == t.CategoryId && c.CategoryType == "Income"))
                .SumAsync(t => (decimal?)t.Amount) ?? 0;

            var lastMonthExpenses = await DbContext.Transaction
                .Where(t => t.CreatedBy == currentUserId
                    && t.DateCreated >= lastMonthStart
                    && t.DateCreated <= lastMonthEnd)
                .Where(t => DbContext.Category.Any(c => c.Id == t.CategoryId && c.CategoryType == "Expense"))
                .SumAsync(t => (decimal?)t.Amount) ?? 0;

            var lastMonthBalance = lastMonthIncome - lastMonthExpenses;

            if (lastMonthBalance != 0)
            {
                percentageChange = ((netBalance - lastMonthBalance) / Math.Abs(lastMonthBalance)) * 100;
            }

            // Load transactions
            var transactions = await DbContext.Transaction
                .Where(t => t.CreatedBy == currentUserId)
                .OrderByDescending(t => t.DateCreated)
                .Take(5)
                .ToListAsync();

            recentTransactions.Clear();
            foreach (var t in transactions)
            {
                var category = await DbContext.Category.FindAsync(t.CategoryId);
                recentTransactions.Add(new TransactionViewModel
                {
                    Date = t.DateCreated,
                    Description = t.Description ?? "",
                    CategoryName = category?.CategoryName ?? "Unknown",
                    Amount = t.Amount,
                    Type = category?.CategoryType ?? "Expense"
                });
            }

            // Load chart data
            await LoadChartData(startOfMonth, endOfMonth);

            Console.WriteLine($"✓ Data loaded - Income: {totalIncome}, Expenses: {totalExpenses}");
            Console.WriteLine($"✓ Chart data - Days: {dailySpendingData.Count}, Categories: {categoryExpenseData.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"✗ Error loading data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadChartData(DateTime startOfMonth, DateTime endOfMonth)
    {
        try
        {
            // Daily spending for line chart (last 30 days)
            var last30Days = DateTime.Now.AddDays(-30).Date;
            var today = DateTime.Now.Date;

            var expenseTransactions = await DbContext.Transaction
                .Where(t => t.CreatedBy == currentUserId
                    && t.DateCreated >= last30Days)
                .Where(t => DbContext.Category.Any(c => c.Id == t.CategoryId && c.CategoryType == "Expense"))
                .ToListAsync();

            // Group existing transactions by date
            var groupedExpenses = expenseTransactions
                .GroupBy(t => t.DateCreated.Date)
                .ToDictionary(g => g.Key, g => g.Sum(t => t.Amount));

            // Create a complete list with ALL days in the range
            dailySpendingData = new List<DailySpending>();

            for (var date = last30Days; date <= today; date = date.AddDays(1))
            {
                dailySpendingData.Add(new DailySpending
                {
                    Date = date,
                    Amount = groupedExpenses.ContainsKey(date) ? groupedExpenses[date] : 0m
                });
            }

            Console.WriteLine($"✓ Chart data loaded: {dailySpendingData.Count} days");

            // Category expenses for pie chart (this month)
            var categoryExpenses = await DbContext.Transaction
                .Where(t => t.CreatedBy == currentUserId
                    && t.DateCreated >= startOfMonth
                    && t.DateCreated <= endOfMonth)
                .Where(t => DbContext.Category.Any(c => c.Id == t.CategoryId && c.CategoryType == "Expense"))
                .ToListAsync();

            var groupedByCategory = categoryExpenses
                .GroupBy(t => t.CategoryId)
                .Select(g => new
                {
                    CategoryId = g.Key,
                    Total = g.Sum(t => t.Amount)
                })
                .OrderByDescending(x => x.Total)
                .Take(5)
                .ToList();

            categoryExpenseData = new List<CategoryExpense>();
            foreach (var item in groupedByCategory)
            {
                var category = await DbContext.Category.FindAsync(item.CategoryId);
                if (category != null)
                {
                    categoryExpenseData.Add(new CategoryExpense
                    {
                        CategoryName = category.CategoryName ?? "Unknown",
                        Amount = item.Total
                    });
                }
            }

            Console.WriteLine($"✓ Category data loaded: {categoryExpenseData.Count} categories");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"✗ Error loading chart data: {ex.Message}");
        }
    }

    private async Task RenderCharts()
    {
        try
        {
            Console.WriteLine("=== ATTEMPTING TO RENDER DASHBOARD CHARTS ===");

            await Task.Delay(500);

            // Check if CORRECT canvases exist
            var canvas1Exists = await JSRuntime.InvokeAsync<bool>("eval",
                "document.getElementById('spendingTrendChart') !== null");
            var canvas2Exists = await JSRuntime.InvokeAsync<bool>("eval",
                "document.getElementById('categoryChart') !== null");

            Console.WriteLine($"Canvas (Spending Trend): {canvas1Exists}");
            Console.WriteLine($"Canvas (Category Chart): {canvas2Exists}");

            if (!canvas1Exists || !canvas2Exists)
            {
                Console.WriteLine("❌ Not all canvases found - aborting");
                return;
            }

            // Check if we have data
            if (dailySpendingData.Count == 0)
            {
                Console.WriteLine("⚠️ No spending data to display");
            }
            else
            {
                // Render Line Chart
                var labels = dailySpendingData.Select(d => d.Date.ToString("MMM dd")).ToArray();
                var data = dailySpendingData.Select(d => (double)d.Amount).ToArray();

                Console.WriteLine($"Rendering line chart with {data.Length} data points");
                await JSRuntime.InvokeVoidAsync("chartHelpers.createLineChart",
                    "spendingTrendChart",
                    labels,
                    data,
                    "Daily Spending");
                Console.WriteLine("✓ Line chart rendered");
            }

            if (categoryExpenseData.Count == 0)
            {
                Console.WriteLine("⚠️ No category data to display");
            }
            else
            {
                // Render Pie Chart
                var categoryLabels = categoryExpenseData.Select(c => c.CategoryName).ToArray();
                var categoryValues = categoryExpenseData.Select(c => (double)c.Amount).ToArray();
                var colors = new[] { "#e91e63", "#2196f3", "#4caf50", "#ff9800", "#9c27b0" };

                Console.WriteLine($"Rendering pie chart with {categoryValues.Length} categories");
                await JSRuntime.InvokeVoidAsync("chartHelpers.createPieChart",
                    "categoryChart",
                    categoryLabels,
                    categoryValues,
                    colors);
                Console.WriteLine("✓ Pie chart rendered");
            }

            Console.WriteLine("✅ ALL CHARTS RENDERED SUCCESSFULLY");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error rendering charts: {ex.Message}");
            Console.WriteLine($"Stack: {ex.StackTrace}");
        }
    }

    private string GetBudgetStatusClass()
    {
        if (budgetUsedPercentage >= 90) return "danger";
        if (budgetUsedPercentage >= 75) return "warning";
        return "";
    }

    public class TransactionViewModel
    {
        public DateTime Date { get; set; }
        public string Description { get; set; } = string.Empty;
        public string CategoryName { get; set; } = string.Empty;
        public decimal Amount { get; set; }
        public string Type { get; set; } = string.Empty;
    }

    public class DailySpending
    {
        public DateTime Date { get; set; }
        public decimal Amount { get; set; }
    }

    public class CategoryExpense
    {
        public string CategoryName { get; set; } = string.Empty;
        public decimal Amount { get; set; }
    }
}
