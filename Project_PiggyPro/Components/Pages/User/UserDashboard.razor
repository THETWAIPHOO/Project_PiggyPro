@page "/User/UserDashboard"
@rendermode InteractiveServer
@layout UserLayout
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Project_PiggyPro.Configurations.Entities
@using Project_PiggyPro.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity

@inject Project_PiggyProContext DbContext
@inject UserManager<Project_PiggyProUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>Dashboard - PiggyPro</PageTitle>

<!-- Welcome Section -->
<div class="welcome-section">
    <h1 class="welcome-title">Welcome back, @userName! 👋</h1>
    <p class="welcome-subtitle">Here's your financial overview for @currentMonth</p>
</div>

<!-- Summary Cards -->
<div class="summary-grid">
    <div class="summary-card">
        <div class="card-title">Total Income</div>
        <div class="card-value income">$@totalIncome.ToString("N2")</div>
        <div class="card-subtitle">This month</div>
    </div>

    <div class="summary-card">
        <div class="card-title">Total Expenses</div>
        <div class="card-value expense">$@totalExpenses.ToString("N2")</div>
        <div class="card-subtitle">This month</div>
    </div>

    <div class="summary-card">
        <div class="card-title">Net Balance</div>
        <div class="card-value">$@netBalance.ToString("N2")</div>
        <div class="card-change @(percentageChange >= 0 ? "positive" : "negative")">
            @(percentageChange >= 0 ? "+" : "")@percentageChange.ToString("N0")% vs last month
        </div>
    </div>

    <div class="summary-card">
        <div class="card-title">Budget Status</div>
        <div class="card-value">@budgetUsedPercentage%</div>
        <div class="card-subtitle">of budget used</div>
        <div class="progress-bar-container">
            <div class="progress-bar @GetBudgetStatusClass()" style="width: @budgetUsedPercentage%"></div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
    <div class="chart-card">
        <div class="chart-title">Spending Overview</div>
        <div class="chart-container">
            <canvas id="spendingChart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-title">Top Categories</div>
        <div class="chart-container">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="transactions-section">
    <div class="section-header">
        <h2 class="section-title">Recent Transactions</h2>
        <a href="/transactions" class="btn-link">View All</a>
    </div>

    @if (recentTransactions.Any())
    {
        <table class="transactions-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var transaction in recentTransactions)
                {
                    <tr>
                        <td>@transaction.Date.ToString("MMM dd, yyyy")</td>
                        <td>@transaction.Description</td>
                        <td>@transaction.CategoryName</td>
                        <td class="@(transaction.Type == "Income" ? "amount-income" : "amount-expense")">
                            @(transaction.Type == "Income" ? "+" : "-")$@transaction.Amount.ToString("N2")
                        </td>
                        <td>
                            <span class="badge @(transaction.Type == "Income" ? "badge-income" : "badge-expense")">
                                @transaction.Type
                            </span>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p class="text-muted">
            No transactions yet.
            <a href="/transactions/create">Add your first transaction</a>
        </p>
    }
</div>

@code {
    private string currentUserId = string.Empty;
    private string userName = string.Empty;
    private string currentMonth = DateTime.Now.ToString("MMMM yyyy");

    private decimal totalIncome = 0;
    private decimal totalExpenses = 0;
    private decimal netBalance = 0;
    private int budgetUsedPercentage = 0;
    private decimal percentageChange = 0;

    private List<TransactionViewModel> recentTransactions = new();
    private List<DailySpending> dailySpendingData = new();
    private List<CategoryExpense> categoryExpenseData = new();

    private bool dataLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var claimsUser = authState.User;

        if (claimsUser?.Identity?.IsAuthenticated == true)
        {
            currentUserId = UserManager.GetUserId(claimsUser) ?? string.Empty;

            var user = await UserManager.GetUserAsync(claimsUser);
            if (user != null)
            {
                userName = string.IsNullOrWhiteSpace(user.FirstName)
                    ? (user.Email ?? "User")
                    : $"{user.FirstName} {user.LastName}".Trim();
            }

            await LoadDashboardData();
            dataLoaded = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && dataLoaded)
        {
            await RenderCharts();
        }
    }

    private async Task LoadDashboardData()
    {
        var startOfMonth = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
        var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);

        totalIncome = await DbContext.Transaction
            .Where(t => t.CreatedBy == currentUserId
                && t.DateCreated >= startOfMonth
                && t.DateCreated <= endOfMonth)
            .Where(t => DbContext.Category.Any(c => c.Id == t.CategoryId && c.CategoryType == "Income"))
            .SumAsync(t => (decimal?)t.Amount) ?? 0;

        totalExpenses = await DbContext.Transaction
            .Where(t => t.CreatedBy == currentUserId
                && t.DateCreated >= startOfMonth
                && t.DateCreated <= endOfMonth)
            .Where(t => DbContext.Category.Any(c => c.Id == t.CategoryId && c.CategoryType == "Expense"))
            .SumAsync(t => (decimal?)t.Amount) ?? 0;

        netBalance = totalIncome - totalExpenses;

        var totalBudget = await DbContext.Budget
            .Where(b => b.CreatedBy == currentUserId)
            .SumAsync(b => (decimal?)b.BudgetAmount) ?? 0;

        if (totalBudget > 0)
        {
            budgetUsedPercentage = (int)((totalExpenses / totalBudget) * 100);
        }

        var lastMonthStart = startOfMonth.AddMonths(-1);
        var lastMonthEnd = startOfMonth.AddDays(-1);

        var lastMonthIncome = await DbContext.Transaction
            .Where(t => t.CreatedBy == currentUserId
                && t.DateCreated >= lastMonthStart
                && t.DateCreated <= lastMonthEnd)
            .Where(t => DbContext.Category.Any(c => c.Id == t.CategoryId && c.CategoryType == "Income"))
            .SumAsync(t => (decimal?)t.Amount) ?? 0;

        var lastMonthExpenses = await DbContext.Transaction
            .Where(t => t.CreatedBy == currentUserId
                && t.DateCreated >= lastMonthStart
                && t.DateCreated <= lastMonthEnd)
            .Where(t => DbContext.Category.Any(c => c.Id == t.CategoryId && c.CategoryType == "Expense"))
            .SumAsync(t => (decimal?)t.Amount) ?? 0;

        var lastMonthBalance = lastMonthIncome - lastMonthExpenses;

        if (lastMonthBalance != 0)
        {
            percentageChange = ((netBalance - lastMonthBalance) / Math.Abs(lastMonthBalance)) * 100;
        }

        var transactions = await DbContext.Transaction
            .Where(t => t.CreatedBy == currentUserId)
            .OrderByDescending(t => t.DateCreated)
            .Take(5)
            .ToListAsync();

        recentTransactions.Clear();

        foreach (var t in transactions)
        {
            var category = await DbContext.Category.FindAsync(t.CategoryId);
            recentTransactions.Add(new TransactionViewModel
            {
                Date = t.DateCreated,
                Description = t.Description ?? "",
                CategoryName = category?.CategoryName ?? "Unknown",
                Amount = t.Amount,
                Type = category?.CategoryType ?? "Expense"
            });
        }

        // Load chart data
        await LoadChartData(startOfMonth, endOfMonth);
    }

    private async Task LoadChartData(DateTime startOfMonth, DateTime endOfMonth)
    {
        // Daily spending for line chart (last 30 days)
        var last30Days = DateTime.Now.AddDays(-30);

        var expenseTransactions = await DbContext.Transaction
            .Where(t => t.CreatedBy == currentUserId
                && t.DateCreated >= last30Days)
            .Where(t => DbContext.Category.Any(c => c.Id == t.CategoryId && c.CategoryType == "Expense"))
            .OrderBy(t => t.DateCreated)
            .ToListAsync();

        dailySpendingData = expenseTransactions
            .GroupBy(t => t.DateCreated.Date)
            .Select(g => new DailySpending
            {
                Date = g.Key,
                Amount = g.Sum(t => t.Amount)
            })
            .OrderBy(d => d.Date)
            .ToList();

        // Category expenses for pie chart (this month)
        var categoryExpenses = await DbContext.Transaction
            .Where(t => t.CreatedBy == currentUserId
                && t.DateCreated >= startOfMonth
                && t.DateCreated <= endOfMonth)
            .Where(t => DbContext.Category.Any(c => c.Id == t.CategoryId && c.CategoryType == "Expense"))
            .ToListAsync();

        var groupedByCategory = categoryExpenses
            .GroupBy(t => t.CategoryId)
            .Select(g => new
            {
                CategoryId = g.Key,
                Total = g.Sum(t => t.Amount)
            })
            .OrderByDescending(c => c.Total)
            .Take(5)
            .ToList();

        categoryExpenseData.Clear();
        foreach (var item in groupedByCategory)
        {
            var category = await DbContext.Category.FindAsync(item.CategoryId);
            categoryExpenseData.Add(new CategoryExpense
            {
                CategoryName = category?.CategoryName ?? "Unknown",
                Amount = item.Total
            });
        }

        Console.WriteLine($"Loaded {dailySpendingData.Count} days of spending data");
        Console.WriteLine($"Loaded {categoryExpenseData.Count} categories");
    }

    private async Task RenderCharts()
    {
        try
        {
            Console.WriteLine("=== ATTEMPTING TO RENDER DASHBOARD CHARTS ===");

            // Wait for canvases to be in DOM
            await Task.Delay(500);

            // Check if canvases exist
            var canvas1Exists = await JSRuntime.InvokeAsync<bool>("eval",
                "document.getElementById('spendingChart') !== null");
            var canvas2Exists = await JSRuntime.InvokeAsync<bool>("eval",
                "document.getElementById('categoryChart') !== null");

            Console.WriteLine($"Spending Chart Canvas: {canvas1Exists}");
            Console.WriteLine($"Category Chart Canvas: {canvas2Exists}");

            if (!canvas1Exists || !canvas2Exists)
            {
                Console.WriteLine("❌ Canvases not found - aborting");
                return;
            }

            // Prepare spending chart data
            var spendingLabels = dailySpendingData.Select(d => d.Date.ToString("MMM dd")).ToArray();
            var spendingValues = dailySpendingData.Select(d => (double)d.Amount).ToArray();

            Console.WriteLine($"Spending data: {spendingValues.Length} points");

            // Prepare category chart data
            var categoryLabels = categoryExpenseData.Select(c => c.CategoryName).ToArray();
            var categoryValues = categoryExpenseData.Select(c => (double)c.Amount).ToArray();

            Console.WriteLine($"Category data: {categoryValues.Length} categories");

            // Render Line Chart
            Console.WriteLine("Rendering spending line chart...");
            await JSRuntime.InvokeVoidAsync("chartHelpers.createLineChart",
                "spendingChart",
                spendingLabels,
                spendingValues,
                "Daily Spending");

            // Render Pie Chart
            Console.WriteLine("Rendering category pie chart...");
            var colors = new[] { "#e91e63", "#2196f3", "#4caf50", "#ff9800", "#9c27b0" };
            await JSRuntime.InvokeVoidAsync("chartHelpers.createPieChart",
                "categoryChart",
                categoryLabels,
                categoryValues,
                colors);

            Console.WriteLine("✅ ALL DASHBOARD CHARTS RENDERED SUCCESSFULLY");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error rendering dashboard charts: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    private string GetBudgetStatusClass()
    {
        if (budgetUsedPercentage >= 90) return "danger";
        if (budgetUsedPercentage >= 75) return "warning";
        return "";
    }

    public class TransactionViewModel
    {
        public DateTime Date { get; set; }
        public string Description { get; set; } = string.Empty;
        public string CategoryName { get; set; } = string.Empty;
        public decimal Amount { get; set; }
        public string Type { get; set; } = string.Empty;
    }

    public class DailySpending
    {
        public DateTime Date { get; set; }
        public decimal Amount { get; set; }
    }

    public class CategoryExpense
    {
        public string CategoryName { get; set; } = string.Empty;
        public decimal Amount { get; set; }
    }
}
