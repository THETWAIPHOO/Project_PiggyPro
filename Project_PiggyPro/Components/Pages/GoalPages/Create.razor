@page "/goals/create"
@layout UserLayout
@attribute [Authorize]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Project_PiggyPro.Components.Layout
@using Project_PiggyPro.Data
@using Project_PiggyPro.Domain
@using Project_PiggyPro.Services

@inject GoalService GoalService
@inject UserManager<Project_PiggyProUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<PageTitle>Create Goal - PiggyPro</PageTitle>

<div class="create-goal-container">
    <div class="page-header">
        <div>
            <h1>🎯 Create New Goal</h1>
            <p class="subtitle">Set a new savings target and start tracking your progress</p>
        </div>
        <a href="/goals" class="btn-back">← Back to Goals</a>
    </div>

    <div class="form-card">
        <EditForm Model="@newGoal" OnValidSubmit="@HandleSubmit" OnInvalidSubmit="@HandleInvalidSubmit">
            <DataAnnotationsValidator />

            @* Show ALL validation errors at top *@
            <ValidationSummary />

            <div class="form-section">
                <h2 class="section-title">📝 Goal Details</h2>

                <div class="form-group">
                    <label for="goalName" class="form-label">Goal Name <span class="required">*</span></label>
                    <InputText id="goalName" class="form-control" @bind-Value="newGoal.GoalName"
                               placeholder="e.g., New Laptop, Vacation Fund, Emergency Savings" />
                    <ValidationMessage For="@(() => newGoal.GoalName)" class="validation-message" />
                </div>

                <div class="form-group">
                    <label for="description" class="form-label">Description</label>
                    <InputTextArea id="description" class="form-control textarea" @bind-Value="newGoal.Description"
                                   rows="3" placeholder="What's this goal for? (Optional)" />
                    <ValidationMessage For="@(() => newGoal.Description)" class="validation-message" />
                </div>

                <div class="form-group">
                    <label for="category" class="form-label">Category</label>
                    <InputSelect id="category" class="form-control" @bind-Value="newGoal.Category">
                        <option value="">Select a category (Optional)</option>
                        <option value="Electronics">📱 Electronics</option>
                        <option value="Travel">✈️ Travel</option>
                        <option value="Emergency Fund">🚨 Emergency Fund</option>
                        <option value="Education">📚 Education</option>
                        <option value="Home">🏠 Home</option>
                        <option value="Vehicle">🚗 Vehicle</option>
                        <option value="Health">💪 Health & Fitness</option>
                        <option value="Investment">💼 Investment</option>
                        <option value="Wedding">💍 Wedding</option>
                        <option value="Other">🎯 Other</option>
                    </InputSelect>
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">💰 Financial Details</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="targetAmount" class="form-label">Target Amount <span class="required">*</span></label>
                        <div class="input-with-icon">
                            <span class="input-icon">$</span>
                            <InputNumber id="targetAmount" class="form-control with-icon" @bind-Value="newGoal.TargetAmount"
                                         step="0.01" placeholder="5000.00" />
                        </div>
                        <ValidationMessage For="@(() => newGoal.TargetAmount)" class="validation-message" />
                    </div>

                    <div class="form-group">
                        <label for="targetDate" class="form-label">Target Date <span class="required">*</span></label>
                        <InputDate id="targetDate" class="form-control" @bind-Value="newGoal.TargetDate"
                                   min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        <ValidationMessage For="@(() => newGoal.TargetDate)" class="validation-message" />
                        @if (newGoal.TargetDate > DateTime.Today)
                        {
                            var daysUntil = (newGoal.TargetDate - DateTime.Today).Days;
                            <small class="form-hint">That's @daysUntil days from now</small>
                        }
                    </div>
                </div>

                @if (newGoal.TargetAmount > 0 && newGoal.TargetDate > DateTime.Today)
                {
                    var monthsUntil = ((newGoal.TargetDate.Year - DateTime.Today.Year) * 12) +
                    newGoal.TargetDate.Month - DateTime.Today.Month;
                    if (monthsUntil > 0)
                    {
                        var monthlyTarget = newGoal.TargetAmount / monthsUntil;
                        <div class="calculation-card">
                            <div class="calculation-icon">📊</div>
                            <div class="calculation-content">
                                <div class="calculation-title">Suggested Monthly Savings</div>
                                <div class="calculation-amount">@monthlyTarget.ToString("C2")</div>
                                <div class="calculation-detail">Save this amount each month to reach your goal on time</div>
                            </div>
                        </div>
                    }
                }
            </div>

            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="status-message @(isSuccess ? "success" : "error")">
                    @statusMessage
                </div>
            }

            @* Debug Info - Remove after testing *@
            @if (!string.IsNullOrEmpty(debugMessage))
            {
                <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Debug Info:</strong>
                    <pre style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">@debugMessage</pre>
                </div>
            }

            <div class="form-actions">
                <button type="button" class="btn-secondary" @onclick="HandleCancel">Cancel</button>
                <button type="submit" class="btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span>Creating...</span>
                    }
                    else
                    {
                        <span>✨ Create Goal</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>

    <div class="tips-card">
        <h3>💡 Goal Setting Tips</h3>
        <ul>
            <li><strong>Be Specific:</strong> Clear goals are easier to achieve</li>
            <li><strong>Start Small:</strong> Begin with achievable targets to build momentum</li>
            <li><strong>Set Deadlines:</strong> A timeline helps maintain focus and urgency</li>
            <li><strong>Track Progress:</strong> Regular updates keep you motivated</li>
            <li><strong>Celebrate Milestones:</strong> Acknowledge progress along the way</li>
        </ul>
    </div>
</div>

@code {
    private Goal newGoal = new Goal();
    private string currentUserId = string.Empty;
    private bool isSubmitting = false;
    private string statusMessage = string.Empty;
    private string debugMessage = string.Empty;
    private bool isSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var appUser = await UserManager.GetUserAsync(user);
                if (appUser != null)
                {
                    currentUserId = appUser.Id;

                    // Initialize the goal with default values INCLUDING AppUserId
                    newGoal = new Goal
                    {
                        TargetDate = DateTime.Today.AddMonths(6),
                        Status = "Active",
                        CurrentAmount = 0,
                        GoalName = string.Empty,
                        TargetAmount = 0,
                        AppUserId = currentUserId,      // ✅ SET IT HERE!
                        CreatedBy = currentUserId,       // ✅ SET IT HERE!
                        UpdatedBy = currentUserId        // ✅ SET IT HERE!
                    };

                    debugMessage = $"User ID: {currentUserId}";
                }
                else
                {
                    debugMessage = "AppUser is null";
                }
            }
            else
            {
                debugMessage = "User not authenticated";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error initializing: {ex.Message}";
            debugMessage = $"Init Error: {ex.Message}\n{ex.StackTrace}";
            Console.WriteLine($"Error in OnInitializedAsync: {ex}");
        }
    }

    private void HandleInvalidSubmit()
    {
        statusMessage = "⚠️ Please check the form for errors.";
        isSuccess = false;

        // Debug: Show what's wrong
        debugMessage = $"Form validation failed!\n" +
                      $"GoalName: '{newGoal.GoalName}' (length: {newGoal.GoalName?.Length ?? 0})\n" +
                      $"TargetAmount: {newGoal.TargetAmount}\n" +
                      $"TargetDate: {newGoal.TargetDate}\n" +
                      $"Status: '{newGoal.Status}'\n" +
                      $"CurrentAmount: {newGoal.CurrentAmount}\n" +
                      $"UserID: '{currentUserId}'";

        Console.WriteLine("Form validation failed!");
        Console.WriteLine(debugMessage);
    }

    private async Task HandleSubmit()
    {
        try
        {
            isSubmitting = true;
            statusMessage = string.Empty;

            Console.WriteLine("HandleSubmit called!");

            if (string.IsNullOrEmpty(currentUserId))
            {
                statusMessage = "❌ User not found. Please log in again.";
                debugMessage = "CurrentUserId is empty!";
                isSuccess = false;
                return;
            }

            debugMessage = $"Attempting to create goal:\n" +
                          $"Name: {newGoal.GoalName}\n" +
                          $"Target: {newGoal.TargetAmount:C2}\n" +
                          $"Date: {newGoal.TargetDate:yyyy-MM-dd}\n" +
                          $"Status: {newGoal.Status}\n" +
                          $"UserID: {newGoal.AppUserId}";

            Console.WriteLine(debugMessage);

            var success = await GoalService.CreateGoalAsync(newGoal);

            if (success)
            {
                Console.WriteLine("Goal created successfully!");
                Navigation.NavigateTo("/goals");
            }
            else
            {
                isSuccess = false;
                statusMessage = "❌ Failed to create goal. Please try again.";
                debugMessage += "\n\nService returned false!";
                Console.WriteLine("Service CreateGoalAsync returned false");
            }
        }
        catch (Exception ex)
        {
            isSuccess = false;
            statusMessage = $"❌ Error creating goal: {ex.Message}";
            debugMessage = $"Exception in HandleSubmit:\n{ex.Message}\n{ex.StackTrace}";
            Console.WriteLine($"Error in HandleSubmit: {ex}");
            Console.WriteLine(debugMessage);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void HandleCancel()
    {
        Navigation.NavigateTo("/goals");
    }
}