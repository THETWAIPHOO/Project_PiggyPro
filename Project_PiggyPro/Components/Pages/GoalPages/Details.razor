@page "/goals/details"
@using Microsoft.EntityFrameworkCore
@using Project_PiggyPro.Domain
@inject IDbContextFactory<Project_PiggyPro.Data.Project_PiggyProContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Goal Details</PageTitle>

<h1>Goal Details</h1>

<div>
    <hr />
    @if (goal is null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">@goal.GoalName</h3>

                @if (!string.IsNullOrEmpty(goal.Description))
                {
                    <p class="card-text">@goal.Description</p>
                }

                <dl class="row mt-3">
                    <dt class="col-sm-3">Target Amount</dt>
                    <dd class="col-sm-9">@goal.TargetAmount.ToString("C")</dd>

                    <dt class="col-sm-3">Current Amount</dt>
                    <dd class="col-sm-9">@goal.CurrentAmount.ToString("C")</dd>

                    <dt class="col-sm-3">Remaining</dt>
                    <dd class="col-sm-9">@goal.RemainingAmount.ToString("C")</dd>

                    <dt class="col-sm-3">Progress</dt>
                    <dd class="col-sm-9">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar @GetProgressBarClass(goal.ProgressPercentage)"
                                 role="progressbar"
                                 style="width: @Math.Min(goal.ProgressPercentage, 100)%"
                                 aria-valuenow="@goal.ProgressPercentage"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                @goal.ProgressPercentage.ToString("F1")%
                            </div>
                        </div>
                    </dd>

                    <dt class="col-sm-3">Target Date</dt>
                    <dd class="col-sm-9">@goal.TargetDate.ToString("MMM dd, yyyy")</dd>

                    <dt class="col-sm-3">Days Remaining</dt>
                    <dd class="col-sm-9">
                        @if (goal.DaysRemaining > 0)
                        {
                            <span class="badge bg-info">@goal.DaysRemaining days</span>
                        }
                        else if (goal.DaysRemaining == 0)
                        {
                            <span class="badge bg-warning">Due Today</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">@Math.Abs(goal.DaysRemaining) days overdue</span>
                        }
                    </dd>

                    <dt class="col-sm-3">Status</dt>
                    <dd class="col-sm-9">
                        <span class="badge @GetStatusBadgeClass(goal.Status)">@goal.Status</span>
                    </dd>

                    @if (!string.IsNullOrEmpty(goal.Category))
                    {
                        <dt class="col-sm-3">Category</dt>
                        <dd class="col-sm-9">@goal.Category</dd>
                    }

                    <dt class="col-sm-3">Date Created</dt>
                    <dd class="col-sm-9">@goal.DateCreated.ToString("MMM dd, yyyy")</dd>

                    <dt class="col-sm-3">Last Updated</dt>
                    <dd class="col-sm-9">@goal.DateUpdated.ToString("MMM dd, yyyy")</dd>
                </dl>

                <div class="mt-4">
                    <a href="@($"/goals/edit?id={goal.Id}")" class="btn btn-primary">Edit</a>
                    <a href="@($"/goals/delete?id={goal.Id}")" class="btn btn-danger">Delete</a>
                    <a href="/goals" class="btn btn-secondary">Back to List</a>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private Goal? goal;

    [SupplyParameterFromQuery]
    private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        goal = await context.Goal.FirstOrDefaultAsync(m => m.Id == Id);

        if (goal is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private string GetProgressBarClass(decimal percentage)
    {
        if (percentage >= 100) return "bg-success";
        if (percentage >= 75) return "bg-info";
        if (percentage >= 50) return "bg-primary";
        if (percentage >= 25) return "bg-warning";
        return "bg-danger";
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Active" => "bg-primary",
            "Completed" => "bg-success",
            "Cancelled" => "bg-secondary",
            _ => "bg-secondary"
        };
    }
}