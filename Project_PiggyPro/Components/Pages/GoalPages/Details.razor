@page "/goals/details/{id:int}"
@layout UserLayout
@attribute [Authorize]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Project_PiggyPro.Components.Layout
@using Project_PiggyPro.Data
@using Project_PiggyPro.Domain
@using Project_PiggyPro.Services

@inject GoalService GoalService
@inject UserManager<Project_PiggyProUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<PageTitle>Goal Details - PiggyPro</PageTitle>

<div class="details-container">
    @if (isLoading)
    {
        <div class="loading-state">
            <p>Loading goal details...</p>
        </div>
    }
    else if (goal != null)
    {
        <div class="page-header">
            <div>
                <h1>@goal.GoalName</h1>
                <span class="goal-status @goal.Status.ToLower()">@goal.Status</span>
            </div>
            <div class="header-actions">
                <a href="/goals/edit/@goal.Id" class="btn-edit">✏️ Edit</a>
                <a href="/goals" class="btn-back">← Back</a>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(goal.Description))
        {
            <div class="description-card">
                <p>@goal.Description</p>
            </div>
        }


        <!-- Main Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card current">
                <div class="stat-label">Current Amount</div>
                <div class="stat-value">@goal.CurrentAmount.ToString("C2")</div>
                <div class="stat-icon">💰</div>
            </div>

            <div class="stat-card target">
                <div class="stat-label">Target Amount</div>
                <div class="stat-value">@goal.TargetAmount.ToString("C2")</div>
                <div class="stat-icon">🎯</div>
            </div>

            <div class="stat-card remaining">
                <div class="stat-label">Remaining</div>
                <div class="stat-value">@goal.RemainingAmount.ToString("C2")</div>
                <div class="stat-icon">📊</div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-card">
            <div class="progress-header">
                <h2>Progress Tracker</h2>
                <span class="progress-percentage">@goal.ProgressPercentage.ToString("F1")%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: @Math.Min(goal.ProgressPercentage, 100)%">
                    <span class="progress-text">@Math.Min(goal.ProgressPercentage, 100).ToString("F0")%</span>
                </div>
            </div>
            <div class="progress-details">
                <div class="detail-item">
                    <span class="detail-label">Started:</span>
                    <span class="detail-value">@goal.DateCreated.ToString("MMM dd, yyyy")</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Target Date:</span>
                    <span class="detail-value">
                        @goal.TargetDate.ToString("MMM dd, yyyy")
                        @if (goal.Status == "Active")
                        {
                            if (goal.DaysRemaining > 0)
                            {
                                <span class="days-info">(@goal.DaysRemaining days left)</span>
                            }
                            else if (goal.DaysRemaining == 0)
                            {
                                <span class="days-info today">Due today!</span>
                            }
                            else
                            {
                                <span class="days-info overdue">Overdue by @(-goal.DaysRemaining) days</span>
                            }
                        }
                    </span>
                </div>
                @if (!string.IsNullOrEmpty(goal.Category))
                {
                    <div class="detail-item">
                        <span class="detail-label">Category:</span>
                        <span class="detail-value category">@goal.Category</span>
                    </div>
                }
            </div>
        </div>

        <!-- Fund Management Section -->
        @if (goal.Status == "Active")
        {
            <div class="fund-management-grid">
                <!-- Add Funds Card -->
                <div class="fund-card add-funds">
                    <div class="fund-header">
                        <h3>💵 Add Funds</h3>
                        <p>Allocate from your savings budget</p>
                    </div>
                    <div class="fund-input-group">
                        <div class="input-with-icon">
                            <span class="input-icon">$</span>
                            <input type="number" class="fund-input" @bind="addAmount"
                                   step="0.01" min="0.01" max="@availableSavings" placeholder="0.00" />
                        </div>
                        <button type="button" class="btn-add" @onclick="HandleAddFunds"
                                disabled="@(addAmount <= 0 || addAmount > availableSavings)">
                            ➕ Add
                        </button>
                    </div>
                    @if (addAmount > 0)
                    {
                        if (addAmount <= availableSavings)
                        {
                            var newTotal = goal.CurrentAmount + addAmount;
                            var newProgress = (newTotal / goal.TargetAmount) * 100;
                            var newAvailable = availableSavings - addAmount;
                            <div class="preview-info add">
                                <div class="preview-row">
                                    <span>New goal total:</span>
                                    <strong>@newTotal.ToString("C2")</strong>
                                </div>
                                <div class="preview-row">
                                    <span>Progress:</span>
                                    <strong>@newProgress.ToString("F1")%</strong>
                                </div>
                                <div class="preview-row">
                                    <span>Remaining savings:</span>
                                    <strong>@newAvailable.ToString("C2")</strong>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="preview-info error">
                                <span>⚠️ Not enough savings budget available!</span>
                                <span>Available: @availableSavings.ToString("C2")</span>
                            </div>
                        }
                    }
                </div>

                <!-- Withdraw Funds Card -->
                <div class="fund-card withdraw-funds">
                    <div class="fund-header">
                        <h3>💸 Withdraw Funds</h3>
                        <p>Return money to savings budget</p>
                    </div>
                    <div class="fund-input-group">
                        <div class="input-with-icon">
                            <span class="input-icon">$</span>
                            <input type="number" class="fund-input" @bind="withdrawAmount"
                                   step="0.01" min="0.01" max="@goal.CurrentAmount" placeholder="0.00" />
                        </div>
                        <button type="button" class="btn-withdraw" @onclick="HandleWithdrawFunds"
                                disabled="@(withdrawAmount <= 0 || withdrawAmount > goal.CurrentAmount)">
                            ➖ Withdraw
                        </button>
                    </div>
                    @if (withdrawAmount > 0)
                    {
                        if (withdrawAmount <= goal.CurrentAmount)
                        {
                            var newTotal = goal.CurrentAmount - withdrawAmount;
                            var newProgress = (newTotal / goal.TargetAmount) * 100;
                            var newAvailable = availableSavings + withdrawAmount;
                            <div class="preview-info withdraw">
                                <div class="preview-row">
                                    <span>New goal total:</span>
                                    <strong>@newTotal.ToString("C2")</strong>
                                </div>
                                <div class="preview-row">
                                    <span>Progress:</span>
                                    <strong>@newProgress.ToString("F1")%</strong>
                                </div>
                                <div class="preview-row">
                                    <span>Available savings:</span>
                                    <strong>@newAvailable.ToString("C2")</strong>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="preview-info error">
                                <span>⚠️ Amount exceeds goal balance</span>
                            </div>
                        }
                    }
                </div>
            </div>
        }
        else if (goal.Status == "Completed")
        {
            <div class="completion-card">
                <div class="completion-icon">🎉</div>
                <h2>Goal Completed!</h2>
                <p>Congratulations on reaching your savings target!</p>
                <p class="completion-date">Completed on: @goal.DateUpdated.ToString("MMM dd, yyyy")</p>
            </div>
        }

        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="status-message @(isSuccess ? "success" : "error")">
                @statusMessage
            </div>
        }
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-card">
            <div class="error-icon">❌</div>
            <h2>Goal Not Found</h2>
            <p>@errorMessage</p>
            <a href="/goals" class="btn-primary">← Back to Goals</a>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    private Goal? goal;
    private string currentUserId = string.Empty;
    private bool isLoading = true;
    private decimal addAmount = 0;
    private decimal withdrawAmount = 0;
    private decimal availableSavings = 0;
    private decimal totalInGoals = 0;
    private string statusMessage = string.Empty;
    private string errorMessage = string.Empty;
    private bool isSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var appUser = await UserManager.GetUserAsync(user);
                if (appUser != null)
                {
                    currentUserId = appUser.Id;
                    await LoadGoal();
                    await LoadSavingsInfo();
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error initializing: {ex.Message}";
            Console.WriteLine($"Error in OnInitializedAsync: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadGoal()
    {
        try
        {
            goal = await GoalService.GetGoalByIdAsync(Id, currentUserId);
            if (goal == null)
            {
                errorMessage = "Goal not found or you don't have permission to view it.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load goal: {ex.Message}";
            Console.WriteLine($"Error loading goal: {ex}");
        }
    }

    private async Task LoadSavingsInfo()
    {
        try
        {
            availableSavings = await GoalService.GetAvailableSavingsBudgetAsync(currentUserId);
            totalInGoals = await GoalService.GetTotalInGoalsAsync(currentUserId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading savings info: {ex}");
        }
    }

    private async Task HandleAddFunds()
    {
        try
        {
            if (addAmount <= 0)
            {
                statusMessage = "⚠️ Please enter a valid amount";
                isSuccess = false;
                return;
            }

            if (addAmount > availableSavings)
            {
                statusMessage = $"⚠️ Not enough savings budget available. You have {availableSavings:C2} available.";
                isSuccess = false;
                return;
            }

            var success = await GoalService.AddFundsToGoalAsync(Id, addAmount, currentUserId);
            if (success)
            {
                isSuccess = true;
                statusMessage = $"✅ Successfully added {addAmount:C2} to your goal from savings!";
                addAmount = 0;
                await LoadGoal();
                await LoadSavingsInfo();
            }
            else
            {
                isSuccess = false;
                statusMessage = "❌ Failed to add funds. Please try again.";
            }
        }
        catch (Exception ex)
        {
            isSuccess = false;
            statusMessage = $"❌ Error adding funds: {ex.Message}";
            Console.WriteLine($"Error in HandleAddFunds: {ex}");
        }
    }

    private async Task HandleWithdrawFunds()
    {
        try
        {
            if (withdrawAmount <= 0)
            {
                statusMessage = "⚠️ Please enter a valid amount";
                isSuccess = false;
                return;
            }

            if (goal != null && withdrawAmount > goal.CurrentAmount)
            {
                statusMessage = "⚠️ Withdrawal amount exceeds goal balance";
                isSuccess = false;
                return;
            }

            var success = await GoalService.WithdrawFundsFromGoalAsync(Id, withdrawAmount, currentUserId);
            if (success)
            {
                isSuccess = true;
                statusMessage = $"✅ Successfully withdrew {withdrawAmount:C2} and returned to savings!";
                withdrawAmount = 0;
                await LoadGoal();
                await LoadSavingsInfo();
            }
            else
            {
                isSuccess = false;
                statusMessage = "❌ Failed to withdraw funds. Please try again.";
            }
        }
        catch (Exception ex)
        {
            isSuccess = false;
            statusMessage = $"❌ Error withdrawing funds: {ex.Message}";
            Console.WriteLine($"Error in HandleWithdrawFunds: {ex}");
        }
    }
}