@page "/notifications/{id:int}"
@rendermode InteractiveServer
@layout UserLayout
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Project_PiggyPro.Domain
@using Project_PiggyPro.Services
@inject IInAppNotificationService NotificationService
@inject UserManager<Project_PiggyPro.Data.Project_PiggyProUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<PageTitle>Notification Details - PiggyPro</PageTitle>

<div class="notification-details-page">
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading...</p>
        </div>
    }
    else if (notification != null)
    {
        <div class="back-button">
            <button @onclick="GoBack">← Back to Notifications</button>
        </div>

        <div class="details-card">
            <div class="details-icon">@notification.Icon</div>

            <div class="details-header">
                <h1>@notification.Title</h1>
                @if (!notification.IsRead)
                {
                    <span class="unread-badge">Unread</span>
                }
            </div>

            <div class="details-message">
                @notification.Message
            </div>

            <div class="details-info-grid">
                <div class="info-card">
                    <div class="info-label">Type</div>
                    <div class="info-value">@notification.NotificationType</div>
                </div>

                <div class="info-card">
                    <div class="info-label">Priority</div>
                    <div class="info-value priority-@notification.Priority.ToLower()">
                        @notification.Priority
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-label">Received</div>
                    <div class="info-value">
                        @notification.DateCreated.ToString("MMM dd, yyyy")
                        <br />
                        <small>@notification.DateCreated.ToString("hh:mm tt")</small>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-label">Status</div>
                    <div class="info-value">
                        @if (notification.IsRead)
                        {
                            <span>✓ Read</span>
                            <br />
                            <small>@notification.ReadAt?.ToString("MMM dd, hh:mm tt")</small>
                        }
                        else
                        {
                            <span>○ Unread</span>
                        }
                    </div>
                </div>
            </div>

            <div class="actions-section">
                @if (!notification.IsRead)
                {
                    <button class="btn-mark-read" @onclick="MarkAsRead">
                        ✓ Mark as Read
                    </button>
                }

                @if (!string.IsNullOrEmpty(notification.ActionUrl))
                {
                    <button class="btn-goto" @onclick="GoToAction">
                        Go to Related Page →
                    </button>
                }

                <button class="btn-delete" @onclick="ShowDeleteConfirm">
                    🗑️ Delete
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="error-state">
            <h2>Notification Not Found</h2>
            <p>This notification may have been deleted.</p>
            <button @onclick="GoBack">← Back to Notifications</button>
        </div>
    }
</div>

<!-- Delete Confirmation -->
@if (showDeleteConfirm)
{
    <div class="modal-overlay" @onclick="() => showDeleteConfirm = false">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h2>Delete Notification?</h2>
            <p>Are you sure you want to delete this notification? This cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn-cancel" @onclick="() => showDeleteConfirm = false">Cancel</button>
                <button class="btn-confirm" @onclick="ConfirmDelete">Delete</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Notification? notification;
    private bool isLoading = true;
    private bool showDeleteConfirm = false;
    private string currentUserId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated == true)
        {
            currentUserId = UserManager.GetUserId(user) ?? string.Empty;
            await LoadNotification();
        }
    }

    private async Task LoadNotification()
    {
        isLoading = true;

        var allNotifications = await NotificationService.GetAllNotificationsAsync(currentUserId);
        notification = allNotifications.FirstOrDefault(n => n.Id == Id);

        // Mark as read when viewing
        if (notification != null && !notification.IsRead)
        {
            await NotificationService.MarkAsReadAsync(notification.Id);
            notification.IsRead = true;
            notification.ReadAt = DateTime.Now;
        }

        isLoading = false;
    }

    private async Task MarkAsRead()
    {
        if (notification != null && !notification.IsRead)
        {
            await NotificationService.MarkAsReadAsync(notification.Id);
            await LoadNotification();
        }
    }

    private void ShowDeleteConfirm()
    {
        showDeleteConfirm = true;
    }

    private async Task ConfirmDelete()
    {
        if (notification != null)
        {
            await NotificationService.DeleteNotificationAsync(notification.Id);
            Navigation.NavigateTo("/notifications");
        }
    }

    private void GoToAction()
    {
        if (notification != null && !string.IsNullOrEmpty(notification.ActionUrl))
        {
            Navigation.NavigateTo(notification.ActionUrl);
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/notifications");
    }
}
