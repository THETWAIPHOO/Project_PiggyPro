@page "/categories/create"
@layout AdminLayout
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Project_PiggyPro.Domain
@using Project_PiggyPro.Data
@inject IDbContextFactory<Project_PiggyProContext> DbFactory
@inject UserManager<Project_PiggyProUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<PageTitle>Create Category - PiggyPro Admin</PageTitle>

<div class="create-container">
    <div class="page-header">
        <div>
            <h1>📁 Create New Category</h1>
            <p class="subtitle">Add a new category for budget tracking</p>
        </div>
        <a href="/categories" class="btn-back">← Back to Categories</a>
    </div>

    <div class="form-card">
        <EditForm Model="@newCategory" OnValidSubmit="@HandleSubmit">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label for="categoryName" class="form-label">Category Name <span class="required">*</span></label>
                <InputText id="categoryName" class="form-control" @bind-Value="newCategory.CategoryName"
                           placeholder="e.g., Groceries, Salary, Savings" />
                <ValidationMessage For="@(() => newCategory.CategoryName)" class="validation-message" />
            </div>

            <div class="form-group">
                <label for="categoryType" class="form-label">Category Type <span class="required">*</span></label>
                <InputSelect id="categoryType" class="form-control" @bind-Value="newCategory.CategoryType">
                    <option value="">Select type...</option>
                    <option value="Income">💰 Income</option>
                    <option value="Expense">💸 Expense</option>
                    <option value="Savings">🐷 Savings</option>
                </InputSelect>
                <ValidationMessage For="@(() => newCategory.CategoryType)" class="validation-message" />
            </div>

            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="status-message @(isSuccess ? "success" : "error")">
                    @statusMessage
                </div>
            }

            <div class="form-actions">
                <button type="button" class="btn-secondary" @onclick="HandleCancel">Cancel</button>
                <button type="submit" class="btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span>Creating...</span>
                    }
                    else
                    {
                        <span>Create Category</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private Category newCategory = new();
    private string currentUserId = string.Empty;
    private bool isSubmitting = false;
    private string statusMessage = string.Empty;
    private bool isSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var appUser = await UserManager.GetUserAsync(user);
                if (appUser != null)
                {
                    currentUserId = appUser.Id;
                }
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error initializing: {ex.Message}";
            isSuccess = false;
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            isSubmitting = true;
            statusMessage = string.Empty;

            if (string.IsNullOrEmpty(currentUserId))
            {
                statusMessage = "User not found. Please log in again.";
                isSuccess = false;
                return;
            }

            using var context = DbFactory.CreateDbContext();

            newCategory.DateCreated = DateTime.Now;
            newCategory.DateUpdated = DateTime.Now;
            newCategory.CreatedBy = currentUserId;
            newCategory.UpdatedBy = currentUserId;
            newCategory.AppUserId = currentUserId;

            context.Category.Add(newCategory);
            await context.SaveChangesAsync();

            Navigation.NavigateTo("/categories");
        }
        catch (Exception ex)
        {
            isSuccess = false;
            statusMessage = $"Error creating category: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void HandleCancel()
    {
        Navigation.NavigateTo("/categories");
    }
}