@page "/categories/edit"
@layout AdminLayout
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Project_PiggyPro.Domain
@using Project_PiggyPro.Data
@inject IDbContextFactory<Project_PiggyProContext> DbFactory
@inject UserManager<Project_PiggyProUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<PageTitle>Edit Category - PiggyPro Admin</PageTitle>

<div class="edit-container">
    <div class="page-header">
        <div>
            <h1>✏️ Edit Category</h1>
            <p class="subtitle">Update category information</p>
        </div>
        <a href="/categories" class="btn-back">← Back to Categories</a>
    </div>

    @if (isLoading)
    {
        <div class="loading-state">
            <p>Loading category...</p>
        </div>
    }
    else if (category == null)
    {
        <div class="error-card">
            <h2>Category Not Found</h2>
            <p>The category you're looking for doesn't exist.</p>
            <a href="/categories" class="btn-primary">Back to Categories</a>
        </div>
    }
    else
    {
        <div class="form-card">
            <EditForm Model="@category" OnValidSubmit="@HandleSubmit">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <label for="categoryName" class="form-label">Category Name <span class="required">*</span></label>
                    <InputText id="categoryName" class="form-control" @bind-Value="category.CategoryName" />
                    <ValidationMessage For="@(() => category.CategoryName)" class="validation-message" />
                </div>

                <div class="form-group">
                    <label for="categoryType" class="form-label">Category Type <span class="required">*</span></label>
                    <InputSelect id="categoryType" class="form-control" @bind-Value="category.CategoryType">
                        <option value="">Select type...</option>
                        <option value="Income">💰 Income</option>
                        <option value="Expense">💸 Expense</option>
                        <option value="Savings">🐷 Savings</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => category.CategoryType)" class="validation-message" />
                </div>

                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">Created:</span>
                        <span class="info-value">@category.DateCreated.ToString("MMM dd, yyyy")</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Last Updated:</span>
                        <span class="info-value">@category.DateUpdated.ToString("MMM dd, yyyy")</span>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(statusMessage))
                {
                    <div class="status-message @(isSuccess ? "success" : "error")">
                        @statusMessage
                    </div>
                }

                <div class="form-actions">
                    <button type="button" class="btn-secondary" @onclick="HandleCancel">Cancel</button>
                    <button type="submit" class="btn-primary" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>Save Changes</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    private Category? category;
    private string currentUserId = string.Empty;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string statusMessage = string.Empty;
    private bool isSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var appUser = await UserManager.GetUserAsync(user);
                if (appUser != null)
                {
                    currentUserId = appUser.Id;
                }
            }

            await LoadCategory();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error initializing: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCategory()
    {
        using var context = DbFactory.CreateDbContext();
        category = await context.Category.FirstOrDefaultAsync(c => c.Id == Id);
    }

    private async Task HandleSubmit()
    {
        try
        {
            isSubmitting = true;
            statusMessage = string.Empty;

            using var context = DbFactory.CreateDbContext();

            category!.DateUpdated = DateTime.Now;
            category.UpdatedBy = currentUserId;

            context.Attach(category).State = EntityState.Modified;
            await context.SaveChangesAsync();

            Navigation.NavigateTo("/categories");
        }
        catch (DbUpdateConcurrencyException)
        {
            isSuccess = false;
            statusMessage = "Category was modified or deleted by another user.";
        }
        catch (Exception ex)
        {
            isSuccess = false;
            statusMessage = $"Error updating category: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void HandleCancel()
    {
        Navigation.NavigateTo("/categories");
    }
}