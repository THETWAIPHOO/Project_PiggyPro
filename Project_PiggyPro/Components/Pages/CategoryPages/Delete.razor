@page "/categories/delete"
@layout AdminLayout
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Project_PiggyPro.Domain
@using Project_PiggyPro.Data
@inject IDbContextFactory<Project_PiggyProContext> DbFactory
@inject NavigationManager Navigation

<PageTitle>Delete Category - PiggyPro Admin</PageTitle>

<div class="delete-container">
    <div class="page-header">
        <h1>🗑️ Delete Category</h1>
        <a href="/categories" class="btn-back">← Cancel</a>
    </div>

    @if (isLoading)
    {
        <div class="loading-state">
            <p>Loading category...</p>
        </div>
    }
    else if (category == null)
    {
        <div class="error-card">
            <h2>Category Not Found</h2>
            <p>The category you're trying to delete doesn't exist.</p>
            <a href="/categories" class="btn-primary">Back to Categories</a>
        </div>
    }
    else
    {
        <div class="warning-card">
            <div class="warning-icon">⚠️</div>
            <div class="warning-content">
                <h2>Are you sure you want to delete this category?</h2>
                <p>This action cannot be undone. All budgets using this category may be affected.</p>
            </div>
        </div>

        <div class="category-preview">
            <div class="preview-header">
                <h3>Category to be deleted:</h3>
            </div>
            <div class="preview-details">
                <div class="detail-row">
                    <span class="label">Name:</span>
                    <span class="value">@category.CategoryName</span>
                </div>
                <div class="detail-row">
                    <span class="label">Type:</span>
                    <span class="value">
                        @GetCategoryIcon(category.CategoryType) @category.CategoryType
                    </span>
                </div>
                <div class="detail-row">
                    <span class="label">Created:</span>
                    <span class="value">@category.DateCreated.ToString("MMM dd, yyyy")</span>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="status-message error">
                @statusMessage
            </div>
        }

        <div class="action-buttons">
            <button type="button" class="btn-cancel" @onclick="HandleCancel">
                Cancel
            </button>
            <button type="button" class="btn-delete" @onclick="HandleDelete" disabled="@isDeleting">
                @if (isDeleting)
                {
                    <span>Deleting...</span>
                }
                else
                {
                    <span>🗑️ Yes, Delete Category</span>
                }
            </button>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    private Category? category;
    private bool isLoading = true;
    private bool isDeleting = false;
    private string statusMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategory();
    }

    private async Task LoadCategory()
    {
        try
        {
            using var context = DbFactory.CreateDbContext();
            category = await context.Category.FirstOrDefaultAsync(c => c.Id == Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading category: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleDelete()
    {
        try
        {
            isDeleting = true;
            statusMessage = string.Empty;

            using var context = DbFactory.CreateDbContext();

            if (category != null)
            {
                context.Category.Remove(category);
                await context.SaveChangesAsync();
                Navigation.NavigateTo("/categories");
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error deleting category: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void HandleCancel()
    {
        Navigation.NavigateTo("/categories");
    }

    private string GetCategoryIcon(string categoryType)
    {
        return categoryType?.ToLower() switch
        {
            "income" => "💰",
            "expense" => "💸",
            "savings" => "🐷",
            _ => "📁"
        };
    }
}