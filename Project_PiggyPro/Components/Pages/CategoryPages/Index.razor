@page "/categories"
@layout AdminLayout
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Project_PiggyPro.Domain
@using Project_PiggyPro.Data
@inject IDbContextFactory<Project_PiggyProContext> DbFactory
@inject NavigationManager Navigation

<PageTitle>Categories - PiggyPro Admin</PageTitle>

<div class="categories-container">
    <div class="page-header">
        <div>
            <h1>📁 Category Management</h1>
            <p class="subtitle">Manage budget categories for your users</p>
        </div>
        <a href="/categories/create" class="btn-primary">+ Create Category</a>
    </div>

    @if (isLoading)
    {
        <div class="loading-state">
            <p>Loading categories...</p>
        </div>
    }
    else if (!categories.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">📂</div>
            <h2>No Categories Yet</h2>
            <p>Create your first category to get started</p>
            <a href="/categories/create" class="btn-primary">Create Category</a>
        </div>
    }
    else
    {
        <!-- Categories Grid -->
        <div class="categories-grid">
            @foreach (var category in categories)
            {
                <div class="category-card @category.CategoryType.ToLower()">
                    <div class="card-header">
                        <div class="category-info">
                            <h3 class="category-name">@category.CategoryName</h3>
                            <span class="category-type">@category.CategoryType</span>
                        </div>
                        <span class="category-icon">
                            @GetCategoryIcon(category.CategoryType)
                        </span>
                    </div>

                    <div class="card-details">
                        <div class="detail-row">
                            <span class="detail-label">Created:</span>
                            <span class="detail-value">@category.DateCreated.ToString("MMM dd, yyyy")</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Last Updated:</span>
                            <span class="detail-value">@category.DateUpdated.ToString("MMM dd, yyyy")</span>
                        </div>
                    </div>

                    <div class="card-actions">
                        <a href="/categories/details?id=@category.Id" class="btn-action view">View</a>
                        <a href="/categories/edit?id=@category.Id" class="btn-action edit">Edit</a>
                        <a href="/categories/delete?id=@category.Id" class="btn-action delete">Delete</a>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Category> categories = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        try
        {
            using var context = DbFactory.CreateDbContext();
            categories = await context.Category
                .OrderBy(c => c.CategoryType)
                .ThenBy(c => c.CategoryName)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading categories: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetCategoryIcon(string categoryType)
    {
        return categoryType?.ToLower() switch
        {
            "income" => "💰",
            "expense" => "💸",
            "savings" => "🐷",
            _ => "📁"
        };
    }
}